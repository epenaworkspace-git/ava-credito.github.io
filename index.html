<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AVA ‚Äî Formulario Permisos Guerrero</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet"/>
<script src="https://www.google.com/recaptcha/api.js?render=6Lc9zGUsAAAAAG2K5TAav3VrS9obGfFqXO5cnOkV"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --navy:#0A1F44;--blue:#165DFF;--blue-l:#3a76ff;
  --dark:#333;--gray:#6B7280;--border:#D8E0F0;
  --ok:#10B981;--err:#EF4444;
  --r:12px;--sh:0 4px 24px rgba(10,31,68,.10);--sh2:0 8px 40px rgba(10,31,68,.18);
  --bg-page:#EEF2FB;--card-bg:#fff;--input-bg:#fff;--input-color:#333;
  --label-color:#0A1F44;--helper-color:#6B7280;--hd-text:#fff;
  --mid:#6B7280;--lt:#9CA3AF;
  --gray-100:#F4F6FA;--gray-200:#D8E0F0;--gray-400:#9CA3AF;--gray-500:#6B7280;
}
body.dark{
  --navy:#7aa2f7;--blue:#4d8aff;--blue-l:#6ba3ff;
  --dark:#c9d1e0;--gray:#7a8fb0;--border:#2a3a5c;
  --bg-page:#0c1525;--card-bg:rgba(17,28,50,0.97);
  --input-bg:#162040;--input-color:#d0d8ec;
  --label-color:#7a8fb0;--helper-color:#4a5878;--hd-text:#e8edf8;
  --mid:#7a8fb0;--lt:#3a4e70;
  --gray-100:#1a2540;--gray-200:#2a3a5c;--gray-400:#4a5878;--gray-500:#7a8fb0;
}
body{font-family:'DM Sans',sans-serif;background:var(--bg-page);color:var(--dark);min-height:100vh;transition:background .3s,color .3s}

/* HEADER */
header{background:#0A1F44;padding:28px 20px 24px;text-align:center;position:relative;overflow:hidden}
body.dark header{background:#07111f}
header::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 80% 60% at 50% -10%,rgba(22,93,255,.35) 0%,transparent 70%)}
.logo{font-family:'Outfit',sans-serif;font-size:42px;font-weight:700;color:#fff;letter-spacing:-1px;position:relative}
.logo span{color:#4d8aff}
.subtitle{font-family:'Outfit',sans-serif;font-size:11px;font-weight:500;letter-spacing:4px;color:rgba(255,255,255,.65);text-transform:uppercase;margin-top:4px;position:relative}

/* LAYOUT */
main{max-width:780px;margin:32px auto 120px;padding:0 16px}
.card{background:var(--card-bg);border-radius:18px;box-shadow:var(--sh);margin-bottom:20px;overflow:hidden;transition:background .3s}
.card-hd{background:#0A1F44;padding:14px 24px;display:flex;align-items:center;gap:10px}
body.dark .card-hd{background:#07111f}
.card-hd-ico{width:32px;height:32px;background:rgba(22,93,255,.25);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px}
.card-hd h2{font-family:'Outfit',sans-serif;font-size:14px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:#fff}
.card-bd{padding:28px 24px;display:flex;flex-direction:column;gap:18px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
@media(max-width:580px){.grid-2{grid-template-columns:1fr}}

/* FIELDS */
.field{display:flex;flex-direction:column;gap:6px}
.field label{font-size:12px;font-weight:600;color:var(--label-color);letter-spacing:.5px;text-transform:uppercase;transition:color .3s}
.req{color:var(--blue);margin-left:2px}
.helper{font-size:11px;color:var(--helper-color);margin-top:2px;line-height:1.5}
.ferr{font-size:11px;color:var(--err);font-weight:500;margin-top:2px;display:none}
.ferr.on{display:block}

/* INPUTS */
input[type=text],input[type=email],input[type=date]{
  width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:var(--r);
  font-family:'DM Sans',sans-serif;font-size:14px;color:var(--input-color);background:var(--input-bg);
  outline:none;transition:border-color .2s,box-shadow .2s,background .3s,color .3s;
  -webkit-appearance:none;appearance:none
}
input[type=text]{text-transform:uppercase}
input[type=text]::placeholder,input[type=email]::placeholder{text-transform:none}
input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(22,93,255,.10)}
input.vi{border-color:var(--err)!important;box-shadow:0 0 0 3px rgba(239,68,68,.08)!important}
input.vok{border-color:var(--ok)!important}
input::placeholder{color:var(--helper-color)}
input[readonly]{background:var(--gray-100)!important;color:var(--mid)!important;cursor:default}

/* CUSTOM SELECT */
.csel{position:relative}
.csel-btn{
  width:100%;display:flex;align-items:center;justify-content:space-between;gap:8px;
  padding:11px 14px;border:1.5px solid var(--border);border-radius:var(--r);
  background:var(--input-bg);cursor:pointer;font-family:'DM Sans',sans-serif;font-size:14px;
  color:var(--input-color);user-select:none;transition:border-color .2s,box-shadow .2s,background .3s;text-align:left
}
.csel-btn:hover{border-color:var(--blue)}
.csel-btn.open{border-color:var(--blue);box-shadow:0 0 0 3px rgba(22,93,255,.10)}
.csel-ph{color:var(--helper-color)}
.csel-arrow{flex-shrink:0;transition:transform .2s;stroke:var(--gray)}
.csel-btn.open .csel-arrow{transform:rotate(180deg)}

/* Panel */
.csel-panel{
  position:absolute;left:0;top:calc(100% + 6px);
  z-index:2000;width:100%;min-width:220px;
  background:var(--card-bg);border:1.5px solid var(--border);border-radius:var(--r);
  box-shadow:0 10px 40px rgba(10,31,68,.18);
  display:none;flex-direction:column;overflow:hidden;
  max-height:260px;
}
.csel-panel.open{display:flex}
.csel-panel.up{top:auto;bottom:calc(100% + 6px)}

.csel-srchwrap{padding:8px 10px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--card-bg)}
.csel-srchwrap input{
  width:100%;padding:7px 10px;border:1.5px solid var(--border);border-radius:8px;
  font-size:13px;font-family:'DM Sans',sans-serif;outline:none;
  background:var(--input-bg);color:var(--input-color);text-transform:none!important
}
.csel-srchwrap input:focus{border-color:var(--blue)}
.csel-scroll{overflow-y:auto;flex:1}
.csel-grp{
  padding:6px 14px 3px;font-size:10px;font-weight:700;letter-spacing:1.5px;
  text-transform:uppercase;color:var(--gray);background:var(--gray-100);
  position:sticky;top:0;z-index:1
}
.csel-opt{
  padding:10px 16px;cursor:pointer;font-size:14px;color:var(--dark);
  transition:background .12s;border-bottom:1px solid rgba(216,224,240,.35)
}
.csel-opt:last-child{border-bottom:none}
.csel-opt:hover,.csel-opt:focus{background:rgba(22,93,255,.07);outline:none}
body.dark .csel-opt:hover{background:rgba(77,138,255,.1)}
.csel-opt.sel{color:var(--blue);font-weight:600;background:rgba(22,93,255,.05)}

/* Velo */
.csel-veil{display:none;position:fixed;inset:0;z-index:1999}
.csel-veil.on{display:block}

/* PHONE ROW */
.phone-row{display:flex;gap:8px}
.lada-wrap{flex-shrink:0;position:relative}
.lada-btn{
  display:flex;align-items:center;gap:6px;padding:11px 12px;
  border:1.5px solid var(--border);border-radius:var(--r);background:var(--input-bg);
  cursor:pointer;white-space:nowrap;min-width:118px;user-select:none;
  transition:border-color .2s,background .3s;height:100%
}
.lada-btn:hover,.lada-btn.open{border-color:var(--blue)}
.lada-code{font-weight:600;font-size:13px;color:var(--navy);transition:color .3s}

/* ‚ïê‚ïê CP FIELDS ‚ïê‚ïê */
.cp-row{position:relative}
.cp-spin{position:absolute;right:12px;top:50%;transform:translateY(-50%);display:none;align-items:center}
.spinner{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* CP EXTRA ‚Äî oculto por defecto, visible cuando CP es v√°lido */
.cp-extra-block{
  display:none;
  flex-direction:column;
  gap:18px;
  animation:fadeSlideIn .35s ease forwards
}
.cp-extra-block.visible{display:flex}
@keyframes fadeSlideIn{
  from{opacity:0;transform:translateY(-8px)}
  to{opacity:1;transform:translateY(0)}
}

/* Badge de CP validado */
.cp-ok-badge{
  display:inline-flex;align-items:center;gap:6px;
  background:rgba(16,185,129,.08);border:1.5px solid rgba(16,185,129,.25);
  border-radius:99px;padding:5px 12px;font-size:12px;font-weight:600;
  color:#059669;margin-top:4px;width:fit-content
}
body.dark .cp-ok-badge{background:rgba(16,185,129,.12);color:#34d399;border-color:rgba(16,185,129,.3)}
.cp-ok-dot{width:7px;height:7px;border-radius:50%;background:#10B981;animation:pdot 2s infinite}
@keyframes pdot{0%,100%{opacity:1}50%{opacity:.3}}

/* Readonly inputs mejorados */
.readonly-field{
  width:100%;padding:11px 14px;
  border:1.5px solid var(--border);border-radius:var(--r);
  font-family:'DM Sans',sans-serif;font-size:14px;
  color:var(--mid);background:var(--gray-100);
  cursor:default;display:flex;align-items:center;gap:8px;
  transition:background .3s,border-color .3s
}
.readonly-field.filled{
  border-color:var(--ok);background:rgba(16,185,129,.04);
  color:var(--input-color);font-weight:500
}
body.dark .readonly-field.filled{background:rgba(16,185,129,.06)}
.readonly-field-ico{font-size:14px;flex-shrink:0}
.readonly-field-val{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-transform:uppercase}

/* DROPZONE */
.attach-dropzone{
  border:2.5px dashed var(--gray-200);border-radius:16px;padding:28px 20px;
  text-align:center;cursor:pointer;transition:all .25s;background:var(--gray-100);position:relative
}
.attach-dropzone:hover,.attach-dropzone.drag-over{border-color:var(--blue);background:rgba(22,93,255,.04)}
body.dark .attach-dropzone{background:#111e36}
.attach-folder-icon{font-size:48px;margin-bottom:12px;display:block;line-height:1}
.attach-dz-text{font-size:13px;color:var(--gray-500);line-height:1.6}
.attach-dz-text a{color:var(--blue);font-weight:600;cursor:pointer;text-decoration:none}
.attach-dz-meta{font-size:12px;color:var(--gray);margin-top:4px}
.attach-dz-badge{font-size:12px;color:var(--blue);font-weight:600;margin-top:5px}
.attach-realtime{display:none;align-items:center;justify-content:center;gap:10px;margin-top:8px;font-size:12px}

/* CAPACITY BAR */
.cap-wrap{margin-top:14px;display:none}
.cap-wrap.on{display:block}
.cap-head{display:flex;justify-content:space-between;margin-bottom:5px;font-size:12px;font-weight:600;color:var(--dark)}
body.dark .cap-head{color:#c8d6f0}
.cap-track{height:9px;background:var(--gray-200);border-radius:99px;overflow:hidden}
.cap-fill{height:100%;border-radius:99px;transition:width .4s ease;position:relative;overflow:hidden;width:0%}
.cap-fill::after{content:'';position:absolute;top:0;left:-60px;width:50px;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.4),transparent);animation:shine 2s infinite}
@keyframes shine{0%{left:-60px}100%{left:calc(100% + 20px)}}
.cap-fill.g{background:linear-gradient(90deg,#0FC373,#12e080)}
.cap-fill.y{background:linear-gradient(90deg,#F59E0B,#fbbf24)}
.cap-fill.r{background:linear-gradient(90deg,#FF4757,#ff6370)}
.cap-status{margin-top:5px;font-size:12px;display:flex;align-items:center;gap:6px}
.cap-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.cap-dot.g{background:#0FC373}
.cap-dot.y{background:#F59E0B}
.cap-dot.r{background:#FF4757;animation:pdot 1s infinite}
.cap-err{background:rgba(255,71,87,.08);border:1.5px solid rgba(255,71,87,.3);border-radius:10px;padding:9px 13px;font-size:12px;color:#d93546;margin-top:8px;display:none;gap:7px;align-items:center}
.cap-err.on{display:flex}

/* COMPRESS */
.compress{display:none;border:1.5px solid var(--border);border-radius:12px;overflow:hidden;margin-top:12px}
.compress.on{display:block}
.compress-hd{background:#0A1F44;padding:10px 14px;display:flex;align-items:center;gap:8px}
body.dark .compress-hd{background:#07111f}
.compress-hd-txt{font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:#fff}
.compress-pct{font-weight:700;color:#4d8aff;font-size:12px;margin-left:auto}
.compress-bd{padding:12px 14px;background:var(--card-bg)}
.compress-row{display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:8px}
.cstat-v{font-size:15px;font-weight:800;color:#0A1F44}
body.dark .cstat-v{color:#7aa2f7}
.cstat-l{font-size:10px;color:var(--gray-400);text-transform:uppercase;letter-spacing:.5px;margin-top:2px}
.c-track{height:7px;background:var(--gray-200);border-radius:99px;overflow:hidden;margin-bottom:6px}
.c-fill{height:100%;background:linear-gradient(90deg,#165DFF,#3a7fff);border-radius:99px;width:0%;transition:width .3s}
.c-info{display:flex;justify-content:space-between;font-size:11px;color:var(--gray-400)}

/* FILE LIST */
.file-list{margin-top:10px;display:flex;flex-direction:column;gap:6px}
.file-item{display:flex;align-items:center;gap:9px;background:var(--gray-100);border:1px solid var(--gray-200);border-radius:10px;padding:8px 11px}
body.dark .file-item{background:#162040;border-color:#2a3a5c}
.file-ico{font-size:17px;flex-shrink:0}
.file-name{flex:1;font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#0A1F44}
body.dark .file-name{color:#c8d6f0}
.file-sz{font-size:12px;color:var(--gray-400);flex-shrink:0}
.file-rm{width:22px;height:22px;border-radius:50%;border:none;background:rgba(255,71,87,.12);color:#FF4757;cursor:pointer;font-size:13px;transition:all .2s;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.file-rm:hover{background:#FF4757;color:#fff}

/* DOCS BOX */
.docs-box{background:rgba(22,93,255,.04);border:1.5px solid rgba(22,93,255,.15);border-radius:10px;padding:13px 15px;font-size:12px;line-height:1.8;margin-top:12px}
body.dark .docs-box{background:rgba(77,138,255,.06);border-color:rgba(77,138,255,.2);color:#9ab0d0}
.docs-box .db-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:#0A1F44;display:block;margin-bottom:8px}
body.dark .docs-box .db-title{color:#c8d6f0}
.legible-ex{margin-top:9px;display:flex;gap:9px}
.lex{flex:1;border-radius:8px;padding:8px 10px;font-size:11px;line-height:1.5}
.lex.ok{background:#e8faf4;border:1px solid #10B981;color:#065f46}
.lex.bad{background:#fef2f2;border:1px solid #EF4444;color:#991b1b}
body.dark .lex.ok{background:#0a2a1e;color:#6ee7b7}
body.dark .lex.bad{background:#2a0a0a;color:#fca5a5}
.lex-label{font-weight:700;font-size:10px;letter-spacing:.8px;text-transform:uppercase;display:block;margin-bottom:3px}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SUMMARY BADGE ‚Äî 3 estados con parpadeo
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.sumbox{background:var(--card-bg);border:1.5px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:20px;box-shadow:var(--sh)}
.sum-hd{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:#0A1F44;position:relative;overflow:hidden}
body.dark .sum-hd{background:#07111f}
.sum-hd::before{content:'';position:absolute;top:-28px;right:-28px;width:110px;height:110px;border-radius:50%;background:radial-gradient(circle,rgba(91,142,255,.25) 0%,transparent 70%);pointer-events:none}
.sum-hd-left{display:flex;align-items:center;gap:10px;position:relative;z-index:1}
.sum-hd-icon{width:32px;height:32px;border-radius:8px;background:rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.sum-hd-icon svg{width:16px;height:16px;fill:#fff}
.sum-ttl{font-size:13px;font-weight:800;color:#fff;letter-spacing:.07em;text-transform:uppercase}
.sum-sub{font-size:11px;color:rgba(255,255,255,.55);margin-top:2px}

/* Badge base */
.sum-badge{
  display:inline-flex;align-items:center;gap:6px;
  border-radius:99px;padding:5px 13px;
  font-size:11px;font-weight:700;letter-spacing:.05em;text-transform:uppercase;
  position:relative;z-index:1;
  transition:background .4s,border-color .4s,color .4s
}

/* Estado: PENDIENTE ‚Äî gris neutro */
.sum-badge.pending{
  background:rgba(107,114,128,.15);
  border:1px solid rgba(107,114,128,.35);
  color:#9CA3AF
}
.sum-badge.pending .badge-dot{
  background:#9CA3AF;
  animation:blink-gray 2s ease-in-out infinite
}

/* Estado: INCOMPLETO ‚Äî √°mbar */
.sum-badge.warn{
  background:rgba(245,158,11,.16);
  border:1px solid rgba(245,158,11,.4);
  color:#fcd34d
}
.sum-badge.warn .badge-dot{
  background:#F59E0B;
  animation:blink-amber 1.4s ease-in-out infinite
}

/* Estado: LISTO ‚Äî verde */
.sum-badge.ok{
  background:rgba(15,195,115,.18);
  border:1px solid rgba(15,195,115,.4);
  color:#6eeabb
}
.sum-badge.ok .badge-dot{
  background:#0FC373;
  animation:blink-green 2s ease-in-out infinite
}

/* Dot base */
.badge-dot{
  width:7px;height:7px;border-radius:50%;flex-shrink:0
}

/* Keyframes de parpadeo por estado */
@keyframes blink-gray{
  0%,100%{opacity:1;transform:scale(1)}
  50%{opacity:.25;transform:scale(.8)}
}
@keyframes blink-amber{
  0%,100%{opacity:1;transform:scale(1)}
  50%{opacity:.2;transform:scale(.75)}
}
@keyframes blink-green{
  0%,100%{opacity:1;transform:scale(1)}
  50%{opacity:.3;transform:scale(.85)}
}

.sum-grp{padding:12px 20px}
.sum-grp+.sum-grp{border-top:1px solid var(--gray-200)}
.sum-grp-lbl{display:flex;align-items:center;gap:7px;margin-bottom:8px}
.sum-grp-lbl-ico{font-size:14px}
.sum-grp-lbl-txt{font-size:11px;font-weight:800;color:var(--blue);letter-spacing:.1em;text-transform:uppercase}
.sum-row{display:flex;align-items:baseline;gap:8px;font-size:13px;line-height:1.9}
.sum-k{color:var(--mid);font-weight:500;min-width:145px;flex-shrink:0;font-size:12px}
.sum-v{color:#1a1a2e;font-weight:600;word-break:break-word;text-transform:uppercase}
body.dark .sum-v{color:#c8d6f0}
.sum-v.empty{color:var(--lt);font-weight:400;font-style:italic;text-transform:none}
.sum-chip{display:inline-flex;align-items:center;background:rgba(22,93,255,.08);color:var(--blue);border:1px solid rgba(22,93,255,.18);border-radius:99px;padding:2px 10px;font-size:11px;font-weight:700}
.sum-chip.files{background:rgba(15,195,115,.09);color:#0a7a49;border-color:rgba(15,195,115,.25)}
body.dark .sum-chip.files{background:rgba(15,195,115,.12);color:#6eeabb}
.sum-footer{border-top:1px solid var(--gray-200);padding:11px 20px;background:var(--gray-100);display:flex;align-items:flex-start;gap:8px}
body.dark .sum-footer{background:#0e1a30;border-top-color:#1e2d50}
.sum-footer-txt{font-size:12px;color:var(--mid);line-height:1.6}
body.dark .sum-footer-txt{color:#c8d6f0}
.sum-footer-txt strong{color:#0A1F44}
body.dark .sum-footer-txt strong{color:#e8edf8}

/* DECLARACI√ìN */
.decl{background:rgba(22,93,255,.03);border:1.5px solid rgba(22,93,255,.2);border-radius:var(--r);padding:18px 20px;display:flex;gap:14px;align-items:flex-start;cursor:pointer;transition:border-color .2s,background .2s;user-select:none}
.decl:hover{border-color:var(--blue)}
.decl.checked{border-color:var(--ok);background:rgba(16,185,129,.06)}
body.dark .decl{background:rgba(77,138,255,.04);border-color:rgba(77,138,255,.2)}
body.dark .decl.checked{background:rgba(16,185,129,.07)}
.decl-chk{width:22px;height:22px;flex-shrink:0;border:2px solid var(--border);border-radius:6px;background:var(--input-bg);display:flex;align-items:center;justify-content:center;margin-top:2px;transition:border-color .2s,background .2s;pointer-events:none}
.decl.checked .decl-chk{border-color:var(--ok);background:var(--ok)}
.decl-mark{display:none;color:#fff;font-size:14px;font-weight:700;line-height:1}
.decl.checked .decl-mark{display:block}
.decl-text{font-size:12px;line-height:1.75;color:var(--dark)}
body.dark .decl-text{color:#c8d6f0}
.decl-text strong{color:#0A1F44}
body.dark .decl-text strong{color:#e8edf8}
.decl-text em{font-style:normal;color:var(--blue);font-weight:600}
.decl-req{font-size:11px;color:var(--err);font-weight:600;margin-top:5px;display:none}

/* SUBMIT */
.btn-submit{
  width:100%;padding:16px;background:var(--blue);color:#fff;
  font-family:'Outfit',sans-serif;font-size:16px;font-weight:600;letter-spacing:.5px;
  border:none;border-radius:var(--r);cursor:pointer;
  transition:background .2s,transform .1s,box-shadow .2s,opacity .3s;
  box-shadow:0 4px 18px rgba(22,93,255,.35);display:flex;align-items:center;justify-content:center;gap:8px
}
.btn-submit:not(:disabled):hover{background:var(--blue-l);transform:translateY(-1px);box-shadow:0 8px 24px rgba(22,93,255,.42)}
.btn-submit:disabled{opacity:.4;cursor:not-allowed;box-shadow:none}
.recap-note{font-size:11px;color:var(--gray);text-align:center;margin-top:10px;line-height:1.5}
.recap-note a{color:var(--blue);text-decoration:none}
.grecaptcha-badge{visibility:visible!important;opacity:1!important;box-shadow:0 4px 18px rgba(0,0,0,.2)!important;border-radius:8px 0 0 8px!important}

/* ENV√çO STATUS */
.send-status{display:none;margin-top:12px;border-radius:12px;padding:14px 18px;font-size:13px;font-weight:500;align-items:center;gap:10px}
.send-status.loading{display:flex;background:rgba(22,93,255,.07);border:1.5px solid rgba(22,93,255,.2);color:#0A1F44}
body.dark .send-status.loading{color:#7aa2f7;background:rgba(77,138,255,.08)}
.send-status.error{display:flex;background:rgba(239,68,68,.07);border:1.5px solid rgba(239,68,68,.25);color:#991b1b}
body.dark .send-status.error{color:#fca5a5}
.send-spinner{width:18px;height:18px;border:2.5px solid rgba(22,93,255,.2);border-top-color:var(--blue);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}

/* PROGRESS BAR */
.prog-wrap{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);z-index:1500;width:calc(100% - 200px);max-width:720px;min-width:280px;pointer-events:none}
.prog-pill{background:#fff;border-radius:60px;padding:10px 20px 10px 16px;display:flex;align-items:center;gap:14px;box-shadow:0 4px 24px rgba(10,31,68,.14);border:1px solid rgba(10,31,68,.07)}
.prog-track{flex:1;height:8px;background:#E8ECF4;border-radius:99px;overflow:hidden}
.prog-fill{height:100%;background:linear-gradient(90deg,#165DFF,#3a7fff);border-radius:99px;width:0%;transition:width .4s cubic-bezier(.4,0,.2,1)}
.prog-txt{font-size:12.5px;font-weight:500;color:#6B7A99;white-space:nowrap;flex-shrink:0;min-width:130px;text-align:right}
.prog-txt strong{color:#165DFF;font-weight:700}
body.dark .prog-pill{background:#1a2645;border-color:rgba(255,255,255,.12);box-shadow:0 4px 28px rgba(0,0,0,.55)}
body.dark .prog-track{background:#263558}
body.dark .prog-fill{background:linear-gradient(90deg,#4d8aff,#78b0ff)}
body.dark .prog-txt{color:#c8d6f0}
body.dark .prog-txt strong{color:#78b0ff}
@media(max-width:640px){.prog-wrap{width:calc(100% - 24px);bottom:14px}.prog-pill{padding:8px 14px 8px 12px;gap:10px}.prog-txt{font-size:11px;min-width:100px}}

/* FLOATING BUTTONS */
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes shine2{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

.float-btn{
  position:fixed;z-index:1900;width:68px;height:68px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;overflow:hidden;
  box-shadow:0 8px 28px rgba(0,0,0,.25),0 0 0 3px #fff;text-decoration:none;
  animation:float 3s ease-in-out infinite;transition:transform .3s,box-shadow .3s
}
.float-btn::before{content:'';position:absolute;inset:0;background:linear-gradient(45deg,transparent 30%,rgba(255,255,255,.25) 50%,transparent 70%);animation:shine2 3s infinite}
.float-btn:hover{animation:none;transform:scale(1.15) translateY(-4px);box-shadow:0 16px 40px rgba(0,0,0,.35),0 0 0 3px #fff}
.float-btn svg{position:relative;z-index:1}
.tramite-btn{top:60px;left:50px;background:linear-gradient(135deg,#0A1F44,#1a3a6e)}
.wa-btn{bottom:20px;left:50px;background:#25D366;animation-delay:.6s}
.tramite-tip{
  position:absolute;left:78px;top:50%;transform:translateY(-50%);
  background:#fff;color:#0A1F44;padding:9px 16px;border-radius:10px;
  white-space:nowrap;box-shadow:0 6px 20px rgba(0,0,0,.15);
  opacity:0;pointer-events:none;transition:all .3s;font-size:14px;font-weight:600;
  border:1px solid rgba(0,0,0,.08)
}
.tramite-btn:hover .tramite-tip{opacity:1;transform:translateY(-50%) translateX(6px)}
body.dark .float-btn{box-shadow:0 8px 28px rgba(0,0,0,.5),0 0 0 3px #1a202c}
body.dark .float-btn:hover{box-shadow:0 16px 40px rgba(0,0,0,.6),0 0 0 3px #1a202c}

/* THEME TOGGLE */
.theme-btn{
  position:fixed;top:16px;right:16px;z-index:2000;
  width:48px;height:48px;border-radius:50%;border:none;cursor:pointer;outline:none;
  background:linear-gradient(145deg,#e8ecf4,#d0d6e8);
  box-shadow:0 5px 18px rgba(0,0,0,.18),inset 0 2px 4px rgba(255,255,255,.9);
  overflow:hidden;transition:all .3s
}
.theme-btn:hover{transform:scale(1.08)}
body.dark .theme-btn{background:linear-gradient(145deg,#1e2d50,#0f1d38);box-shadow:0 5px 18px rgba(0,0,0,.45),0 0 12px rgba(65,105,225,.3)}
.ti-wrap{position:relative;width:100%;height:100%;display:flex;align-items:center;justify-content:center}
.ti,.ti2{position:absolute;width:24px;height:24px;transition:all .4s cubic-bezier(.68,-.55,.265,1.55)}
.ti{opacity:1;transform:scale(1) rotate(0deg)}
.ti2{opacity:0;transform:scale(.4) rotate(-80deg)}
body.dark .ti{opacity:0;transform:scale(.4) rotate(80deg)}
body.dark .ti2{opacity:1;transform:scale(1) rotate(0deg)}

/* SUCCESS MODAL */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(8,18,42,.78);backdrop-filter:blur(7px);z-index:9000;align-items:center;justify-content:center;padding:20px}
.modal-bg.on{display:flex}
.modal-card{background:#fff;border-radius:26px;width:100%;max-width:460px;box-shadow:0 30px 80px rgba(10,31,68,.3);animation:popIn .4s cubic-bezier(.34,1.56,.64,1)}
body.dark .modal-card{background:#111f3a}
@keyframes popIn{from{opacity:0;transform:scale(.82) translateY(18px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-hd{background:linear-gradient(135deg,#0A1F44,#0e2a60);padding:38px 36px 32px;text-align:center;position:relative;overflow:hidden;border-radius:26px 26px 0 0}
.modal-hd::before{content:'';position:absolute;top:-40px;right:-40px;width:160px;height:160px;border-radius:50%;background:radial-gradient(circle,rgba(22,93,255,.35) 0%,transparent 70%)}
.modal-check{width:68px;height:68px;background:linear-gradient(135deg,#165DFF,#0FC373);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 18px;position:relative;z-index:1;box-shadow:0 8px 22px rgba(15,195,115,.42);animation:checkPop .5s .25s cubic-bezier(.34,1.56,.64,1) both}
@keyframes checkPop{from{transform:scale(0) rotate(-20deg)}to{transform:scale(1) rotate(0)}}
.modal-check svg{width:32px;height:32px}
.modal-ttl{font-size:22px;font-weight:800;color:#fff;margin-bottom:6px;position:relative;z-index:1}
.modal-sub{font-size:12px;color:rgba(255,255,255,.6);letter-spacing:1.5px;text-transform:uppercase;position:relative;z-index:1}
.modal-bd{padding:24px 28px 28px}
.modal-row{display:flex;align-items:flex-start;gap:13px;background:var(--gray-100);border-radius:12px;padding:14px 16px;margin-bottom:10px}
body.dark .modal-row{background:#162040}
.modal-row-ico{width:36px;height:36px;border-radius:9px;background:rgba(22,93,255,.1);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.modal-row-ico svg{width:17px;height:17px}
.modal-row-txt{font-size:13px;color:#6B7A99;line-height:1.55}
body.dark .modal-row-txt{color:#9ab0d0}
.modal-row-txt strong{display:block;color:#333;font-size:14px;font-weight:700;margin-bottom:3px}
body.dark .modal-row-txt strong{color:#c8d6f0}
.contact-list{margin-top:6px;display:flex;flex-direction:column;gap:5px}
.contact-item{display:flex;align-items:center;gap:7px;font-size:13px;color:#444;font-weight:500}
body.dark .contact-item{color:#9ab0d0}
.contact-item a{color:var(--blue);text-decoration:none;font-weight:600}
.modal-div{height:1px;background:#E8ECF4;margin:18px 0}
body.dark .modal-div{background:#1e2d50}
.modal-close{width:100%;background:linear-gradient(135deg,#165DFF,#0e46cc);color:#fff;border:none;border-radius:12px;padding:14px;font-size:15px;font-weight:700;cursor:pointer;transition:all .22s;box-shadow:0 5px 18px rgba(22,93,255,.35)}
.modal-close:hover{transform:translateY(-2px);box-shadow:0 10px 28px rgba(22,93,255,.5)}

/* SCROLLBAR */
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px}
</style>
</head>
<body>

<!-- MODAL √âXITO -->
<div class="modal-bg" id="modalBg">
  <div class="modal-card">
    <div class="modal-hd">
      <div class="modal-check">
        <svg viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
      </div>
      <div class="modal-ttl">¬°Solicitud Enviada!</div>
      <div class="modal-sub">Tu tr√°mite est√° en proceso</div>
    </div>
    <div class="modal-bd">
      <div class="modal-row">
        <div class="modal-row-ico">
          <svg viewBox="0 0 24 24" fill="none" stroke="#165DFF" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        </div>
        <div class="modal-row-txt">
          <strong>Siguiente paso</strong>
          Recibir√°s confirmaci√≥n en <strong>24‚Äì48 horas h√°biles</strong>. Revisa tu bandeja y la carpeta de spam.
        </div>
      </div>
      <div class="modal-row">
        <div class="modal-row-ico">
          <svg viewBox="0 0 24 24" fill="none" stroke="#165DFF" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>
        </div>
        <div class="modal-row-txt">
          <strong>Contacto directo</strong>
          <div class="contact-list">
            <div class="contact-item">üìû <a href="tel:+527471234567">+52 (747) 123-4567</a></div>
            <div class="contact-item">‚úâÔ∏è <a href="mailto:info@anpai.com.mx">info@anpai.com.mx</a></div>
            <div class="contact-item">üåê <a href="https://www.anpai.com.mx" target="_blank">www.anpai.com.mx</a></div>
          </div>
        </div>
      </div>
      <div class="modal-div"></div>
      <button class="modal-close" onclick="closeModal()">Volver al Formulario</button>
    </div>
  </div>
</div>

<!-- BOTONES FLOTANTES -->
<a href="https://www.anpai.com.mx/iniciar-tramite" class="float-btn tramite-btn" target="_blank" rel="noopener" aria-label="Iniciar tr√°mite">
  <span class="tramite-tip">üìù Iniciar tr√°mite</span>
  <svg width="34" height="34" viewBox="0 0 24 24" fill="white"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
</a>
<a href="https://wa.me/527471234567" class="float-btn wa-btn" target="_blank" rel="noopener" aria-label="WhatsApp">
  <svg width="34" height="34" viewBox="0 0 24 24" fill="white"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
</a>

<!-- TEMA -->
<button class="theme-btn" id="themeBtn" aria-label="Cambiar tema">
  <div class="ti-wrap">
    <svg class="ti" viewBox="0 0 24 24" fill="none">
      <circle cx="12" cy="12" r="4.5" fill="#FFD700" stroke="#FFA500" stroke-width="1.2"/>
      <g stroke="#FFD700" stroke-width="2" stroke-linecap="round">
        <line x1="12" y1="2.5" x2="12" y2="4.5"/><line x1="12" y1="2.5" x2="12" y2="4.5" transform="rotate(45 12 12)"/>
        <line x1="12" y1="2.5" x2="12" y2="4.5" transform="rotate(90 12 12)"/><line x1="12" y1="2.5" x2="12" y2="4.5" transform="rotate(135 12 12)"/>
        <line x1="12" y1="2.5" x2="12" y2="4.5" transform="rotate(180 12 12)"/><line x1="12" y1="2.5" x2="12" y2="4.5" transform="rotate(225 12 12)"/>
        <line x1="12" y1="2.5" x2="12" y2="4.5" transform="rotate(270 12 12)"/><line x1="12" y1="2.5" x2="12" y2="4.5" transform="rotate(315 12 12)"/>
      </g>
    </svg>
    <svg class="ti2" viewBox="0 0 24 24" fill="none">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="#c8d0ff" stroke="#4169E1" stroke-width="1.4"/>
    </svg>
  </div>
</button>

<header>
  <div class="logo">A<span>V</span>A</div>
  <div class="subtitle">Formulario Permisos Guerrero</div>
</header>

<!-- Velo para cerrar dropdowns -->
<div class="csel-veil" id="veil"></div>

<main>
<form id="ava-form" novalidate autocomplete="off">

  <!-- DATOS PERSONALES -->
  <div class="card">
    <div class="card-hd"><div class="card-hd-ico">üë§</div><h2>Datos Personales</h2></div>
    <div class="card-bd">
      <div class="grid-2">
        <div class="field">
          <label>Nombre<span class="req">*</span></label>
          <input type="text" id="f-nombre" name="nombre" placeholder="Tu nombre" data-req/>
        </div>
        <div class="field">
          <label>Segundo Nombre</label>
          <input type="text" id="f-snombre" name="segundo_nombre" placeholder="Opcional"/>
        </div>
      </div>
      <div class="grid-2">
        <div class="field">
          <label>Apellido Paterno<span class="req">*</span></label>
          <input type="text" id="f-ap" name="apellido_paterno" placeholder="Primer apellido" data-req/>
        </div>
        <div class="field">
          <label>Apellido Materno<span class="req">*</span></label>
          <input type="text" id="f-am" name="apellido_materno" placeholder="Segundo apellido" data-req/>
        </div>
      </div>
      <div class="grid-2">
        <div class="field">
          <label>G√©nero<span class="req">*</span></label>
          <div class="csel">
            <button type="button" class="csel-btn" id="btn-genero" data-target="val-genero">
              <span class="csel-ph">Selecciona...</span>
              <svg class="csel-arrow" width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1l5 5 5-5" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
            <div class="csel-panel" id="panel-btn-genero"></div>
            <input type="hidden" id="val-genero" name="genero" data-req/>
          </div>
        </div>
        <div class="field">
          <label>Fecha de Nacimiento<span class="req">*</span></label>
          <input type="date" id="f-nacimiento" name="fecha_nacimiento" data-req/>
        </div>
      </div>
      <div class="field">
        <label>CURP<span class="req">*</span></label>
        <input type="text" id="f-curp" name="curp" placeholder="Ej. LOOA800101MMCRNS09" maxlength="18" data-req data-val="curp"/>
        <div class="ferr" id="err-curp">CURP inv√°lida ‚Äî debe tener exactamente 18 caracteres con el formato oficial.</div>
        <div class="helper">4 letras ¬∑ 6 d√≠gitos fecha (AAMMDD) ¬∑ H o M ¬∑ 2 letras estado ¬∑ 3 consonantes ¬∑ 2 d√≠gitos.</div>
      </div>
      <div class="field">
        <label>RFC<span class="req">*</span></label>
        <input type="text" id="f-rfc" name="rfc" placeholder="Ej. XEXX010101000" maxlength="13" data-req data-val="rfc"/>
        <div class="ferr" id="err-rfc">RFC inv√°lido ‚Äî persona f√≠sica: 13 caracteres ¬∑ persona moral: 12 caracteres.</div>
        <div class="helper">Persona f√≠sica: 4 letras + fecha AAMMDD + 3 alfanum√©ricos = 13 caracteres.</div>
      </div>

      <!-- ‚ïê‚ïê C√ìDIGO POSTAL + CAMPOS AUTOCOMPLETADOS ‚ïê‚ïê -->
      <div class="field">
        <label>C√≥digo Postal<span class="req">*</span></label>
        <div class="cp-row">
          <input type="text" id="f-cp" name="codigo_postal"
                 placeholder="Ej. 39000" maxlength="5" inputmode="numeric" data-req
                 autocomplete="postal-code"/>
          <div class="cp-spin" id="cp-spin"><div class="spinner"></div></div>
        </div>
        <div id="cp-ok-badge" style="display:none">
          <div class="cp-ok-badge">
            <span class="cp-ok-dot"></span>
            <span id="cp-ok-txt">C√≥digo postal verificado</span>
          </div>
        </div>
        <div class="helper">Ingresa tus 5 d√≠gitos ‚Äî Estado, Municipio y Colonia se completar√°n autom√°ticamente.</div>
      </div>

      <!-- Bloque que se muestra tras validar el CP -->
      <div class="cp-extra-block" id="cp-extra">
        <div class="grid-2">
          <div class="field">
            <label>Estado</label>
            <div class="readonly-field" id="rf-estado">
              <span class="readonly-field-ico">üìç</span>
              <span class="readonly-field-val" id="rf-estado-val">‚Äî</span>
            </div>
            <input type="hidden" id="cp-estado" name="estado"/>
          </div>
          <div class="field">
            <label>Municipio</label>
            <div class="readonly-field" id="rf-municipio">
              <span class="readonly-field-ico">üèôÔ∏è</span>
              <span class="readonly-field-val" id="rf-municipio-val">‚Äî</span>
            </div>
            <input type="hidden" id="cp-municipio" name="municipio"/>
          </div>
        </div>
        <div class="field">
          <label>Colonia<span class="req">*</span></label>
          <div class="csel">
            <button type="button" class="csel-btn" id="btn-colonia" data-target="val-colonia">
              <span class="csel-ph">Selecciona tu colonia...</span>
              <svg class="csel-arrow" width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1l5 5 5-5" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
            <div class="csel-panel" id="panel-btn-colonia"></div>
            <input type="hidden" id="val-colonia" name="colonia"/>
          </div>
          <div class="helper" id="col-count-helper"></div>
        </div>
      </div>
      <!-- /cp-extra-block -->

      <div class="field">
        <label>Tel√©fono<span class="req">*</span></label>
        <div class="phone-row">
          <div class="lada-wrap">
            <div class="lada-btn" id="lada-btn">
              <span id="lada-flag" style="font-size:18px">üá≤üáΩ</span>
              <span class="lada-code" id="lada-code">+52</span>
              <svg width="10" height="6" viewBox="0 0 10 6" fill="none" style="stroke:var(--gray)"><path d="M1 1l4 4 4-4" stroke-width="1.5" stroke-linecap="round"/></svg>
            </div>
            <div class="csel-panel" id="panel-lada" style="min-width:280px"></div>
            <input type="hidden" id="val-lada" name="lada" value="+52"/>
          </div>
          <input type="text" id="f-tel" name="telefono" placeholder="N√∫mero telef√≥nico" inputmode="tel" data-req style="flex:1;text-transform:none"/>
        </div>
      </div>
      <div class="field">
        <label>Correo Electr√≥nico<span class="req">*</span></label>
        <input type="email" id="f-email" name="email" placeholder="correo@ejemplo.com" data-req/>
      </div>
    </div>
  </div>

  <!-- VEH√çCULO -->
  <div class="card">
    <div class="card-hd"><div class="card-hd-ico">üöó</div><h2>Datos del Veh√≠culo</h2></div>
    <div class="card-bd">
      <div class="field">
        <label>Tipo de Veh√≠culo<span class="req">*</span></label>
        <div class="csel">
          <button type="button" class="csel-btn" id="btn-tipo" data-target="val-tipo">
            <span class="csel-ph">Selecciona...</span>
            <svg class="csel-arrow" width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1l5 5 5-5" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <div class="csel-panel" id="panel-btn-tipo"></div>
          <input type="hidden" id="val-tipo" name="tipo_vehiculo" data-req/>
        </div>
      </div>
      <div class="field">
        <label>Marca<span class="req">*</span></label>
        <div class="csel">
          <button type="button" class="csel-btn" id="btn-marca" data-target="val-marca">
            <span class="csel-ph">Selecciona una marca...</span>
            <svg class="csel-arrow" width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1l5 5 5-5" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
          <div class="csel-panel" id="panel-btn-marca"></div>
          <input type="hidden" id="val-marca" name="marca" data-req/>
        </div>
      </div>
      <div class="field" id="marca-otro-wrap" style="display:none">
        <label>Especifica la Marca<span class="req">*</span></label>
        <input type="text" id="f-marca-otro" name="marca_otro" placeholder="Nombre de la marca"/>
      </div>
      <div class="grid-2">
        <div class="field">
          <label>Versi√≥n / Trim<span class="req">*</span></label>
          <input type="text" id="f-version" name="version" placeholder="Ej. LIMITED, SPORT, XLE" data-req/>
        </div>
        <div class="field">
          <label>A√±o Modelo<span class="req">*</span></label>
          <div class="csel">
            <button type="button" class="csel-btn" id="btn-anio" data-target="val-anio">
              <span class="csel-ph">Selecciona a√±o...</span>
              <svg class="csel-arrow" width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1l5 5 5-5" stroke-width="2" stroke-linecap="round"/></svg>
            </button>
            <div class="csel-panel" id="panel-btn-anio"></div>
            <input type="hidden" id="val-anio" name="anio_modelo" data-req/>
          </div>
        </div>
      </div>
      <div class="grid-2">
        <div class="field">
          <label>N√∫mero de Serie (VIN)<span class="req">*</span></label>
          <input type="text" id="f-vin" name="num_serie" placeholder="17 CARACTERES" maxlength="17" data-req/>
          <div class="helper">Tablero, marco de puerta o factura.</div>
        </div>
        <div class="field">
          <label>N√∫mero de Motor<span class="req">*</span></label>
          <input type="text" id="f-motor" name="num_motor" placeholder="EJ. 4A91T12345" data-req/>
          <div class="helper">Bloque del motor o factura.</div>
        </div>
      </div>
      <div class="field">
        <label>Clave Vehicular<span class="req">*</span></label>
        <input type="text" id="f-clave" name="clave_vehicular" placeholder="EJ. 8A9SCAZ5E0001" data-req/>
        <div class="helper">Asignada por el fabricante ‚Äî factura o tarjeta de circulaci√≥n.</div>
      </div>

      <!-- ADJUNTAR -->
      <div class="field">
        <label>Adjuntar Documentos<span class="req">*</span></label>
        <div class="attach-dropzone" id="dropzone"
             ondragover="dzOver(event)" ondragleave="dzLeave(event)" ondrop="dzDrop(event)"
             onclick="document.getElementById('fileInput').click()">
          <span class="attach-folder-icon">üìÅ</span>
          <div class="attach-dz-text">
            Arrastra archivos aqu√≠ o
            <a onclick="event.stopPropagation();document.getElementById('fileInput').click()">haz clic para seleccionar</a>
          </div>
          <div class="attach-dz-meta">Formatos: <strong>PDF, JPG, PNG</strong></div>
          <div class="attach-dz-badge">‚öôÔ∏è Compresi√≥n autom√°tica ZIP incluida</div>
          <div class="attach-dz-meta">üè∑Ô∏è L√≠mite ZIP: <strong>5 MB</strong></div>
          <div class="attach-realtime" id="rt-stats">
            <span>üì¶ <strong id="rt-count">0</strong> archivo(s)</span>
            <span style="color:var(--gray)">|</span>
            <span>ZIP: <strong id="rt-weight">‚Äî</strong></span>
          </div>
          <input type="file" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="addFiles(this.files)"/>
        </div>

        <div class="cap-wrap" id="cap-wrap">
          <div class="cap-head">
            <span style="color:var(--mid)">Capacidad utilizada</span>
            <span id="cap-val">‚Äî de 5 MB</span>
          </div>
          <div class="cap-track"><div class="cap-fill g" id="cap-fill"></div></div>
          <div class="cap-status"><span class="cap-dot g" id="cap-dot"></span><span id="cap-txt">En espera‚Ä¶</span></div>
          <div class="cap-err" id="cap-err"><span>‚ö†Ô∏è</span><span id="cap-err-txt">Error.</span></div>
        </div>

        <div class="compress" id="compress-box">
          <div class="compress-hd">
            <span style="font-size:15px">‚ö°</span>
            <span class="compress-hd-txt">Comprimiendo...</span>
            <span class="compress-pct" id="cpct">0%</span>
          </div>
          <div class="compress-bd">
            <div class="compress-row">
              <div><div class="cstat-v" id="cdone">0 B</div><div class="cstat-l">Comprimido</div></div>
              <div><div class="cstat-v" id="crem">0 B</div><div class="cstat-l">Restante</div></div>
              <div><div class="cstat-v" id="celap">0s</div><div class="cstat-l">Transcurrido</div></div>
              <div><div class="cstat-v" id="ceta">‚Äî</div><div class="cstat-l">Estimado</div></div>
            </div>
            <div class="c-track"><div class="c-fill" id="c-fill"></div></div>
            <div class="c-info"><span id="c-info">Preparando‚Ä¶</span><span id="c-pct2">0%</span></div>
          </div>
        </div>

        <div class="file-list" id="file-list"></div>

        <div class="docs-box">
          <span class="db-title">üìã Documentos requeridos</span>
          <div style="margin-bottom:4px">‚úÖ <strong>Factura del veh√≠culo</strong> ‚Äî PDF completo o imagen con todos los datos visibles.</div>
          <div>‚úÖ <strong>INE por ambos lados</strong> ‚Äî Frente y reverso (pueden ser dos archivos).</div>
          <div style="margin-top:8px;font-size:11px;font-weight:600;color:#0A1F44">‚ö†Ô∏è Todos los documentos deben ser <u>legibles</u>.</div>
          <div class="legible-ex">
            <div class="lex ok"><span class="lex-label">‚úÖ Legible</span>Foto n√≠tida, bien iluminada, encuadre completo.</div>
            <div class="lex bad"><span class="lex-label">‚ùå No legible</span>Imagen borrosa, oscura o recortada.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- RESUMEN -->
  <div class="sumbox" id="sumbox">
    <div class="sum-hd">
      <div class="sum-hd-left">
        <div class="sum-hd-icon">
          <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
        </div>
        <div>
          <div class="sum-ttl">Resumen de Solicitud</div>
          <div class="sum-sub">Revisa tus datos antes de enviar</div>
        </div>
      </div>
      <!-- Badge con dot animado siempre presente -->
      <div class="sum-badge pending" id="sum-badge">
        <span class="badge-dot"></span>
        <span id="sum-badge-txt">Pendiente</span>
      </div>
    </div>
    <div id="sum-body"></div>
    <div class="sum-footer">
      <span style="font-size:16px">‚ÑπÔ∏è</span>
      <p class="sum-footer-txt"><strong>Verifica la informaci√≥n antes de enviar.</strong> Si hay errores, edita el campo correspondiente.</p>
    </div>
  </div>

  <!-- DECLARACI√ìN -->
  <div class="card">
    <div class="card-hd"><div class="card-hd-ico">üìú</div><h2>Declaraci√≥n y Conformidad</h2></div>
    <div class="card-bd">
      <div class="decl" id="decl" onclick="toggleDecl()">
        <div class="decl-chk"><span class="decl-mark">‚úì</span></div>
        <div>
          <div class="decl-text">
            Bajo protesta de decir verdad, declaro que <strong>toda la informaci√≥n y documentaci√≥n proporcionada es aut√©ntica</strong>. Al marcar esta casilla, manifiesto mi conformidad otorgando a esta acci√≥n el mismo valor jur√≠dico que mi firma aut√≥grafa, de conformidad con el <em>art√≠culo 89 del C√≥digo de Comercio</em> y la <em>NOM-151-SCFI-2016</em>.
          </div>
          <div class="decl-req" id="decl-req">‚ö†Ô∏è Debes aceptar la declaraci√≥n para enviar tu solicitud.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ENVIAR -->
  <div>
    <button type="submit" class="btn-submit" id="btn-send" disabled>
      <span>‚úâÔ∏è</span> Enviar Solicitud
    </button>
    <div class="send-status" id="send-status">
      <div class="send-spinner"></div>
      <span id="send-status-txt">Preparando env√≠o...</span>
    </div>
    <div class="recap-note">
      Al enviar aceptas nuestras <a href="#">Pol√≠ticas de Privacidad</a>.<br>
      Este sitio est√° protegido por reCAPTCHA de Google ‚Äî
      <a href="https://policies.google.com/privacy" target="_blank" rel="noopener">Privacidad</a> y
      <a href="https://policies.google.com/terms" target="_blank" rel="noopener">T√©rminos de Servicio</a> aplican.
    </div>
  </div>

</form>
</main>

<!-- BARRA DE PROGRESO -->
<div class="prog-wrap" id="prog-wrap">
  <div class="prog-pill">
    <div class="prog-track"><div class="prog-fill" id="prog-fill"></div></div>
    <span class="prog-txt"><strong id="prog-done">0</strong> de <span id="prog-total">0</span> campos</span>
  </div>
</div>

<script>
'use strict';

var CFG = {
  MAX_ZIP: 5 * 1024 * 1024,
  COPOMEX: '36da398a-1848-44f3-a952-06c9bfb02cc8',
  RECAPTCHA_SITE_KEY: '6Lc9zGUsAAAAAG2K5TAav3VrS9obGfFqXO5cnOkV',
  FORMSUBMIT_URL: 'https://formsubmit.co/info@anpai.com.mx'
};

/* ‚ïê‚ïê TEMA ‚ïê‚ïê */
var THEME_KEY = 'ava-theme';
try { if(localStorage.getItem(THEME_KEY)==='dark') document.body.classList.add('dark'); } catch(e){}
document.getElementById('themeBtn').onclick = function(){
  var d = document.body.classList.toggle('dark');
  try { localStorage.setItem(THEME_KEY, d?'dark':'light'); } catch(e){}
};

/* ‚ïê‚ïê DATOS ‚ïê‚ïê */
var LADAS = [
  {r:'Am√©rica del Norte',c:[{f:'üá®üá¶',n:'Canad√°',d:'+1'},{f:'üá≤üáΩ',n:'M√©xico',d:'+52'},{f:'üá∫üá∏',n:'Estados Unidos',d:'+1'}]},
  {r:'Am√©rica Central y Caribe',c:[{f:'üáßüáø',n:'Belice',d:'+501'},{f:'üá®üá∑',n:'Costa Rica',d:'+506'},{f:'üá®üá∫',n:'Cuba',d:'+53'},{f:'üá∏üáª',n:'El Salvador',d:'+503'},{f:'üá¨üáπ',n:'Guatemala',d:'+502'},{f:'üá≠üáπ',n:'Hait√≠',d:'+509'},{f:'üá≠üá≥',n:'Honduras',d:'+504'},{f:'üáØüá≤',n:'Jamaica',d:'+1-876'},{f:'üá≥üáÆ',n:'Nicaragua',d:'+505'},{f:'üáµüá¶',n:'Panam√°',d:'+507'},{f:'üáµüá∑',n:'Puerto Rico',d:'+1-787'},{f:'üá©üá¥',n:'Rep. Dominicana',d:'+1-809'}]},
  {r:'Am√©rica del Sur',c:[{f:'üá¶üá∑',n:'Argentina',d:'+54'},{f:'üáßüá¥',n:'Bolivia',d:'+591'},{f:'üáßüá∑',n:'Brasil',d:'+55'},{f:'üá®üá±',n:'Chile',d:'+56'},{f:'üá®üá¥',n:'Colombia',d:'+57'},{f:'üá™üá®',n:'Ecuador',d:'+593'},{f:'üáµüáæ',n:'Paraguay',d:'+595'},{f:'üáµüá™',n:'Per√∫',d:'+51'},{f:'üá∫üáæ',n:'Uruguay',d:'+598'},{f:'üáªüá™',n:'Venezuela',d:'+58'}]},
  {r:'Europa',c:[{f:'üá©üá™',n:'Alemania',d:'+49'},{f:'üá™üá∏',n:'Espa√±a',d:'+34'},{f:'üá´üá∑',n:'Francia',d:'+33'},{f:'üáÆüáπ',n:'Italia',d:'+39'},{f:'üáµüáπ',n:'Portugal',d:'+351'},{f:'üá¨üáß',n:'Reino Unido',d:'+44'},{f:'üá∑üá∫',n:'Rusia',d:'+7'}]},
  {r:'Asia',c:[{f:'üá®üá≥',n:'China',d:'+86'},{f:'üáØüáµ',n:'Jap√≥n',d:'+81'},{f:'üá∞üá∑',n:'Corea del Sur',d:'+82'},{f:'üáÆüá≥',n:'India',d:'+91'},{f:'üá∏üá¶',n:'Arabia Saudita',d:'+966'}]}
];
var MARCAS = {
  'Chinas':['BAIC','BYD','Chery','DFSK','Dongfeng','FAW','Foton','GAC','Geely','Haval','JAC','Jetour','Maxus','MG','Nio','Ora','Roewe','Saic','Wuling','Xpeng','Zotye'],
  'Coreanas':['Genesis','Hyundai','Kia','SsangYong'],
  'Europeas':['Alfa Romeo','Aston Martin','Audi','Bentley','BMW','Bugatti','Ferrari','Fiat','Jaguar','Lamborghini','Land Rover','Maserati','McLaren','Mercedes-Benz','MINI','Peugeot','Porsche','Renault','Rolls-Royce','Seat','Skoda','Volkswagen','Volvo'],
  'Estadounidenses':['Buick','Cadillac','Chevrolet','Chrysler','Dodge','Ford','GMC','Jeep','Lincoln','RAM','Tesla'],
  'Japonesas':['Acura','Daihatsu','Honda','Infiniti','Isuzu','Lexus','Mazda','Mitsubishi','Nissan','Subaru','Suzuki','Toyota','Yamaha'],
  'Otra marca':['Otra marca']
};

/* ‚ïê‚ïê ESTADO DE ARCHIVOS ‚ïê‚ïê */
var S = { files:[], zipBlob:null, compressing:false, _runId:0, startTime:null };
var compTimer = null;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CUSTOM SELECT ‚Äî POSICIONAMIENTO FIJO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var currentPanel = null;
var veil = document.getElementById('veil');
veil.onclick = closeAll;

function closeAll(){
  if(currentPanel){
    currentPanel.classList.remove('open');
    currentPanel = null;
  }
  veil.classList.remove('on');
  document.querySelectorAll('.csel-btn.open, .lada-btn.open').forEach(function(b){ b.classList.remove('open'); });
}

function openPanel(panel, btn){
  if(currentPanel && currentPanel !== panel){ closeAll(); }
  if(panel.classList.contains('open')){ closeAll(); return; }

  var r = btn.getBoundingClientRect();
  var spaceBelow = window.innerHeight - r.bottom - 10;
  var panelH = Math.min(260, panel.scrollHeight || 260);

  if(spaceBelow < panelH && r.top > panelH){
    panel.classList.add('up');
    panel.classList.remove('open');
    panel.classList.add('open');
  } else {
    panel.classList.remove('up');
    panel.classList.add('open');
  }

  btn.classList.add('open');
  veil.classList.add('on');
  currentPanel = panel;

  var si = panel.querySelector('.csel-srchwrap input');
  if(si) setTimeout(function(){ si.focus(); }, 60);
}

function makeSelect(btnId, hiddenId, items, searchable, onChange){
  var btn = document.getElementById(btnId);
  var hidden = document.getElementById(hiddenId);
  var panel = document.getElementById('panel-' + btnId);
  if(!btn || !hidden || !panel) return;

  var srchEl = null;
  if(searchable){
    var sw = document.createElement('div'); sw.className = 'csel-srchwrap';
    srchEl = document.createElement('input'); srchEl.type='text'; srchEl.placeholder='Buscar...'; srchEl.style.textTransform='none';
    sw.appendChild(srchEl); panel.appendChild(sw);
  }
  var scroll = document.createElement('div'); scroll.className = 'csel-scroll';
  panel.appendChild(scroll);
  panel.addEventListener('click', function(e){ e.stopPropagation(); });

  var isGrouped = Array.isArray(items) && items.length > 0 && items[0] && items[0].group;

  function render(q){
    q = (q||'').toLowerCase();
    scroll.innerHTML = '';
    function addOpt(text){
      if(q && text.toLowerCase().indexOf(q) < 0) return;
      var d = document.createElement('div'); d.className = 'csel-opt' + (hidden.value===text?' sel':'');
      d.tabIndex = 0; d.textContent = text;
      function pick(){ setSelect(btn, hidden, text); closeAll(); if(onChange) onChange(text); onChange2(); }
      d.onclick = pick;
      d.onkeydown = function(e){ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); pick(); } };
      scroll.appendChild(d);
    }
    if(isGrouped){
      items.forEach(function(g){
        var shown = g.options.filter(function(o){ return !q||o.toLowerCase().indexOf(q)>=0; });
        if(!shown.length) return;
        var grp = document.createElement('div'); grp.className='csel-grp'; grp.textContent=g.group; scroll.appendChild(grp);
        shown.forEach(addOpt);
      });
    } else { items.forEach(addOpt); }
  }

  btn.onclick = function(e){ e.stopPropagation(); render(srchEl?srchEl.value:''); openPanel(panel, btn); };
  if(srchEl){ srchEl.oninput = function(){ render(srchEl.value); }; srchEl.onclick = function(e){ e.stopPropagation(); }; }
  render('');
}

function setSelect(btn, hidden, val){
  hidden.value = val;
  btn.innerHTML = '<span style="color:var(--input-color)">' + esc(val) + '</span>' +
    '<svg class="csel-arrow" width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1l5 5 5-5" stroke-width="2" stroke-linecap="round"/></svg>';
}

/* ‚ïê‚ïê LADA ‚ïê‚ïê */
function initLada(){
  var lbtn = document.getElementById('lada-btn');
  var panel = document.getElementById('panel-lada');
  var flag = document.getElementById('lada-flag');
  var code = document.getElementById('lada-code');
  var valInput = document.getElementById('val-lada');

  var sw = document.createElement('div'); sw.className='csel-srchwrap';
  var si = document.createElement('input'); si.type='text'; si.placeholder='Buscar pa√≠s...'; si.style.textTransform='none';
  sw.appendChild(si); panel.appendChild(sw);
  var scroll = document.createElement('div'); scroll.className='csel-scroll'; panel.appendChild(scroll);
  panel.addEventListener('click',function(e){e.stopPropagation();});

  function render(q){
    q=(q||'').toLowerCase(); scroll.innerHTML='';
    LADAS.forEach(function(region){
      var items = region.c.slice().sort(function(a,b){return a.n.localeCompare(b.n,'es');});
      var matches = items.filter(function(x){return !q||x.n.toLowerCase().indexOf(q)>=0||x.d.indexOf(q)>=0;});
      if(!matches.length) return;
      var grp=document.createElement('div'); grp.className='csel-grp'; grp.textContent=region.r; scroll.appendChild(grp);
      matches.forEach(function(x){
        var d=document.createElement('div'); d.className='csel-opt'; d.style.display='flex'; d.style.alignItems='center';
        d.innerHTML='<span style="font-size:17px;margin-right:8px">'+x.f+'</span>'+esc(x.n)+'<span style="color:var(--blue);font-weight:600;margin-left:auto;padding-left:8px">'+x.d+'</span>';
        d.onclick=function(){ flag.textContent=x.f; code.textContent=x.d; valInput.value=x.d; closeAll(); };
        scroll.appendChild(d);
      });
    });
  }
  lbtn.onclick=function(e){ e.stopPropagation(); render(si.value); openPanel(panel,lbtn); };
  lbtn.onkeydown=function(e){ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); lbtn.click(); } };
  si.oninput=function(){render(si.value);}; si.onclick=function(e){e.stopPropagation();};
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   C√ìDIGO POSTAL ‚Äî COPOMEX
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initCP(){
  var inp    = document.getElementById('f-cp');
  var spin   = document.getElementById('cp-spin');
  var extra  = document.getElementById('cp-extra');
  var badge  = document.getElementById('cp-ok-badge');
  var okTxt  = document.getElementById('cp-ok-txt');
  var t;

  inp.addEventListener('input', function(){
    this.value = this.value.replace(/\D/g, '');
    clearTimeout(t);
    var cp = this.value.trim();
    if(cp.length !== 5){ hideCPExtra(); onChange2(); return; }
    t = setTimeout(function(){ fetchCP(cp); }, 700);
  });

  function hideCPExtra(){
    extra.classList.remove('visible');
    badge.style.display = 'none';
    document.getElementById('cp-estado').value    = '';
    document.getElementById('cp-municipio').value = '';
    document.getElementById('val-colonia').value  = '';
    document.getElementById('rf-estado-val').textContent   = '‚Äî';
    document.getElementById('rf-municipio-val').textContent = '‚Äî';
    document.getElementById('rf-estado').classList.remove('filled');
    document.getElementById('rf-municipio').classList.remove('filled');
    var cb = document.getElementById('btn-colonia');
    cb.innerHTML = '<span class="csel-ph">Selecciona tu colonia...</span>' +
      '<svg class="csel-arrow" width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1l5 5 5-5" stroke-width="2" stroke-linecap="round"/></svg>';
    var cp2 = document.getElementById('panel-btn-colonia'); cp2.innerHTML = '';
    document.getElementById('col-count-helper').textContent = '';
  }

  function fetchCP(cp){
    spin.style.display = 'flex';
    hideCPExtra();

    fetch('https://api.copomex.com/query/info_cp/' + cp + '?token=' + CFG.COPOMEX)
      .then(function(r){ if(!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
      .then(function(data){
        var arr    = Array.isArray(data) ? data : [data];
        var valid  = arr.filter(function(i){ return i && !i.error && i.response; });
        if(!valid.length){ throw new Error('CP no encontrado'); }
        var r0 = valid[0].response;
        var estado = (r0.estado || '').trim();
        document.getElementById('cp-estado').value = estado;
        document.getElementById('rf-estado-val').textContent = estado || '‚Äî';
        document.getElementById('rf-estado').classList.toggle('filled', !!estado);
        var municipio = (r0.municipio || r0.ciudad || '').trim();
        document.getElementById('cp-municipio').value = municipio;
        document.getElementById('rf-municipio-val').textContent = municipio || '‚Äî';
        document.getElementById('rf-municipio').classList.toggle('filled', !!municipio);
        var cols = [];
        if(typeof r0.asentamiento === 'string'){
          cols = valid.map(function(i){ return (i.response.asentamiento || '').trim(); }).filter(Boolean);
        } else if(Array.isArray(r0.asentamiento)){
          cols = r0.asentamiento.map(function(c){ return (c||'').trim(); }).filter(Boolean);
        } else {
          cols = valid.map(function(i){
            return (i.response.asentamiento || i.response.colonia || '').trim();
          }).filter(Boolean);
        }
        cols = [...new Set(cols)].sort(function(a,b){ return a.localeCompare(b,'es'); });
        document.getElementById('val-colonia').value = '';
        var cb  = document.getElementById('btn-colonia');
        var cp2 = document.getElementById('panel-btn-colonia');
        cb.innerHTML = '<span class="csel-ph">Selecciona tu colonia...</span>' +
          '<svg class="csel-arrow" width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1l5 5 5-5" stroke-width="2" stroke-linecap="round"/></svg>';
        cp2.innerHTML = '';
        makeSelect('btn-colonia', 'val-colonia', cols, cols.length > 6);
        var helper = document.getElementById('col-count-helper');
        helper.textContent = cols.length > 0
          ? cols.length + ' colonia' + (cols.length > 1 ? 's' : '') + ' disponible' + (cols.length > 1 ? 's' : '')
          : 'No se encontraron colonias para este C.P.';
        okTxt.textContent = 'C.P. ' + cp + ' verificado ‚Äî ' + municipio + ', ' + estado;
        badge.style.display = 'block';
        extra.classList.add('visible');
      })
      .catch(function(err){
        console.warn('COPOMEX error:', err);
        hideCPExtra();
        badge.style.display = 'none';
      })
      .finally(function(){
        spin.style.display = 'none';
        onChange2();
      });
  }
}

/* ‚ïê‚ïê INIT ‚ïê‚ïê */
document.addEventListener('DOMContentLoaded', function(){
  if(CFG.RECAPTCHA_SITE_KEY && CFG.RECAPTCHA_SITE_KEY !== 'TU_SITE_KEY'){
    var rcScript = document.createElement('script');
    rcScript.src = 'https://www.google.com/recaptcha/api.js?render=' + CFG.RECAPTCHA_SITE_KEY;
    rcScript.async = true;
    document.head.appendChild(rcScript);
  }

  document.getElementById('f-nacimiento').max = new Date().toISOString().split('T')[0];

  makeSelect('btn-genero','val-genero',['Masculino','Femenino']);
  makeSelect('btn-tipo','val-tipo',['Nuevo','Seminuevo']);
  var years=[]; var cy=new Date().getFullYear();
  for(var y=cy+1;y>=1960;y--) years.push(String(y));
  makeSelect('btn-anio','val-anio',years,true);

  var marcaItems = Object.entries(MARCAS).map(function(e){
    return { group: e[0]==='Otra marca'?'Otra':'Marcas '+e[0], options: e[1] };
  });
  makeSelect('btn-marca','val-marca',marcaItems,true,function(val){
    var show = val==='Otra marca';
    document.getElementById('marca-otro-wrap').style.display = show?'block':'none';
    if(!show) document.getElementById('f-marca-otro').value='';
  });

  initLada();
  initCP();
  initValidation();

  document.querySelectorAll('input[type=text]').forEach(function(inp){
    if(['f-tel'].indexOf(inp.id)>=0) return;
    inp.addEventListener('input',function(){
      var s=this.selectionStart,e=this.selectionEnd;
      this.value=this.value.toUpperCase();
      try{this.setSelectionRange(s,e);}catch(_){}
    });
  });

  document.querySelectorAll('[data-req]').forEach(function(el){
    el.addEventListener('input',onChange2);
    el.addEventListener('change',onChange2);
  });
  document.getElementById('f-marca-otro').addEventListener('input',onChange2);

  document.getElementById('prog-wrap').style.display='block';
  buildSummary();
  updateProgress();
  initSubmit();
});

/* ‚ïê‚ïê VALIDACI√ìN ‚ïê‚ïê */
var CURP_RE=/^[A-Z]{4}[0-9]{6}[HM][A-Z]{2}[B-DF-HJ-NP-TV-Z]{3}[A-Z0-9]{2}$/;
var RFC_PF=/^[A-Z√ë&]{4}[0-9]{6}[A-Z0-9]{3}$/;
var RFC_PM=/^[A-Z√ë&]{3}[0-9]{6}[A-Z0-9]{3}$/;

function initValidation(){
  var curp=document.getElementById('f-curp');
  var rfc=document.getElementById('f-rfc');
  curp.addEventListener('input',function(){
    this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
    var ok=CURP_RE.test(this.value);
    this.classList.toggle('vi',this.value.length>0&&!ok);
    this.classList.toggle('vok',ok);
    document.getElementById('err-curp').classList.toggle('on',this.value.length>0&&!ok);
    onChange2();
  });
  rfc.addEventListener('input',function(){
    this.value=this.value.toUpperCase().replace(/[^A-Z√ë&0-9]/g,'');
    var ok=RFC_PF.test(this.value)||RFC_PM.test(this.value);
    this.classList.toggle('vi',this.value.length>0&&!ok);
    this.classList.toggle('vok',ok);
    document.getElementById('err-rfc').classList.toggle('on',this.value.length>0&&!ok);
    onChange2();
  });
}

/* ‚ïê‚ïê ARCHIVOS / ZIP ‚ïê‚ïê */
function dzOver(e){ e.preventDefault(); document.getElementById('dropzone').classList.add('drag-over'); }
function dzLeave(e){ document.getElementById('dropzone').classList.remove('drag-over'); }
function dzDrop(e){ e.preventDefault(); document.getElementById('dropzone').classList.remove('drag-over'); addFiles(e.dataTransfer.files); }

function addFiles(list){
  Array.from(list).forEach(function(f){
    if(!S.files.some(function(x){ return x.name===f.name&&x.size===f.size; })) S.files.push(f);
  });
  S.zipBlob=null;
  renderFiles(); updateCapBar();
  if(S.files.length) scheduleCompress();
  onChange2();
}

function removeFile(i){
  S.files.splice(i,1); S.zipBlob=null;
  renderFiles(); updateCapBar();
  if(S.files.length) scheduleCompress();
  else { document.getElementById('compress-box').classList.remove('on'); }
  onChange2();
}

function renderFiles(){
  var list=document.getElementById('file-list'); list.innerHTML='';
  S.files.forEach(function(f,i){
    var d=document.createElement('div'); d.className='file-item';
    d.innerHTML='<span class="file-ico">'+fileIco(f.name)+'</span>'+
      '<span class="file-name">'+esc(f.name)+'</span>'+
      '<span class="file-sz">'+fmt(f.size)+'</span>'+
      '<button type="button" class="file-rm" onclick="removeFile('+i+')">√ó</button>';
    list.appendChild(d);
  });
  var rt=document.getElementById('rt-stats');
  rt.style.display = S.files.length?'flex':'none';
  document.getElementById('rt-count').textContent=S.files.length;
}

function updateCapBar(){
  var wrap=document.getElementById('cap-wrap');
  var fill=document.getElementById('cap-fill');
  var dot=document.getElementById('cap-dot');
  var txt=document.getElementById('cap-txt');
  var val=document.getElementById('cap-val');
  var err=document.getElementById('cap-err');
  var rtW=document.getElementById('rt-weight');

  if(!S.files.length){ wrap.classList.remove('on'); if(rtW) rtW.textContent='‚Äî'; return; }
  wrap.classList.add('on');

  if(!S.zipBlob){
    fill.className='cap-fill g'; fill.style.width='0%';
    dot.className='cap-dot g'; txt.textContent=S.compressing?'Comprimiendo...':'En espera de compresi√≥n‚Ä¶';
    val.textContent='‚Äî de 5 MB'; if(rtW) rtW.textContent='‚Äî'; err.classList.remove('on'); return;
  }

  var sz=S.zipBlob.size, pct=Math.min(100,(sz/CFG.MAX_ZIP)*100), zs=fmt(sz);
  fill.style.width=pct+'%'; val.textContent=zs+' de 5 MB'; if(rtW) rtW.textContent=zs;
  fill.className='cap-fill'; dot.className='cap-dot';
  if(sz>=CFG.MAX_ZIP){
    fill.classList.add('r'); dot.classList.add('r'); txt.textContent='ZIP supera 5 MB ‚Äî elimina archivos';
    document.getElementById('cap-err-txt').textContent='El ZIP pesa '+zs+'. Supera el l√≠mite de 5 MB.';
    err.classList.add('on');
  } else if(sz>=CFG.MAX_ZIP*.8){
    fill.classList.add('y'); dot.classList.add('y'); txt.textContent='Casi lleno ‚Äî quedan '+fmt(CFG.MAX_ZIP-sz);
    err.classList.remove('on');
  } else {
    fill.classList.add('g'); dot.classList.add('g'); txt.textContent='ZIP listo ‚Äî '+fmt(CFG.MAX_ZIP-sz)+' disponibles';
    err.classList.remove('on');
  }
}

function scheduleCompress(){ clearTimeout(compTimer); compTimer=setTimeout(startCompress,80); }

function startCompress(){
  if(S.compressing) S._runId++;
  if(!S.files.length) return;
  var snap=S.files.slice(), runId=++S._runId, zip=new JSZip();
  var total=snap.reduce(function(a,f){return a+f.size;},0), done=0;
  S.compressing=true; S.zipBlob=null; S.startTime=Date.now();
  document.getElementById('compress-box').classList.add('on');
  updateCapBar();
  var ticker=setInterval(function(){
    if(S._runId!==runId){clearInterval(ticker);return;}
    var el=document.getElementById('celap'); if(el) el.textContent=fmtS((Date.now()-S.startTime)/1000);
  },300);
  function abort(){ clearInterval(ticker); S.compressing=false; document.getElementById('compress-box').classList.remove('on'); }
  function processFile(idx){
    if(S._runId!==runId){abort();return;}
    if(idx>=snap.length){
      document.getElementById('c-info').textContent='Generando ZIP‚Ä¶';
      zip.generateAsync({type:'blob',compression:'DEFLATE',compressionOptions:{level:6}},function(m){
        if(S._runId!==runId) return;
        upCompress(Math.round(m.percent),done,0,(Date.now()-S.startTime)/1000,total);
      }).then(function(blob){
        clearInterval(ticker);
        if(S._runId!==runId){abort();return;}
        S.compressing=false; S.zipBlob=blob;
        document.getElementById('compress-box').classList.remove('on');
        updateCapBar(); onChange2();
      }).catch(function(){ abort(); });
      return;
    }
    var f=snap[idx], reader=new FileReader();
    reader.onload=function(ev){
      if(S._runId!==runId){abort();return;}
      zip.file(f.name,ev.target.result);
      done+=f.size;
      var pct=Math.round((done/total)*70);
      upCompress(pct,done,total-done,(Date.now()-S.startTime)/1000,total);
      setTimeout(function(){processFile(idx+1);},0);
    };
    reader.onerror=function(){setTimeout(function(){processFile(idx+1);},0);};
    reader.readAsArrayBuffer(f);
  }
  processFile(0);
}

function upCompress(pct,done,rem,elap,total){
  var p=document.getElementById('cpct'); if(p) p.textContent=pct+'%';
  var b=document.getElementById('c-fill'); if(b) b.style.width=pct+'%';
  var d=document.getElementById('cdone'); if(d) d.textContent=fmt(done);
  var r=document.getElementById('crem'); if(r) r.textContent=fmt(rem);
  var p2=document.getElementById('c-pct2'); if(p2) p2.textContent=pct+'% completado';
  var e=document.getElementById('celap'); if(e) e.textContent=fmtS(elap);
  var eta=document.getElementById('ceta'); if(eta) eta.textContent=(pct>5&&elap>0)?fmtS((elap/pct)*(100-pct)):'‚Äî';
  var i=document.getElementById('c-info'); if(i) i.textContent='Procesando '+S.files.length+' archivo(s)‚Ä¶';
}

/* ‚ïê‚ïê RESUMEN ‚ïê‚ïê */
function gv(id){ var e=document.getElementById(id); return e?e.value.trim():''; }
function esc(s){ var d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   L√ìGICA DEL BADGE ‚Äî 3 estados
   ‚Ä¢ pending  ‚Üí ning√∫n campo obligatorio tocado a√∫n
   ‚Ä¢ warn     ‚Üí al menos 1 campo llenado, pero faltan obligatorios
   ‚Ä¢ ok       ‚Üí todos los campos obligatorios cumplidos
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getBadgeState(){
  var complete = isComplete();
  if(complete) return 'ok';

  /* Detectar si el usuario ha empezado a llenar el formulario */
  var started = false;

  /* Campos de texto / fecha / email */
  var textIds = ['f-nombre','f-snombre','f-ap','f-am','f-nacimiento',
                 'f-curp','f-rfc','f-cp','f-tel','f-email',
                 'f-version','f-vin','f-motor','f-clave','f-marca-otro'];
  for(var i=0;i<textIds.length;i++){
    var el = document.getElementById(textIds[i]);
    if(el && el.value && el.value.trim()){ started = true; break; }
  }

  /* Selects ocultos */
  if(!started){
    var selIds = ['val-genero','val-tipo','val-marca','val-anio','val-colonia'];
    for(var j=0;j<selIds.length;j++){
      var sel = document.getElementById(selIds[j]);
      if(sel && sel.value && sel.value.trim()){ started = true; break; }
    }
  }

  /* Archivos adjuntos */
  if(!started && S.files.length > 0) started = true;

  return started ? 'warn' : 'pending';
}

function updateBadge(){
  var badge   = document.getElementById('sum-badge');
  var badgeTxt = document.getElementById('sum-badge-txt');
  if(!badge || !badgeTxt) return;

  var state = getBadgeState();

  /* Quitar todas las clases de estado */
  badge.classList.remove('pending','warn','ok');
  badge.classList.add(state);

  if(state === 'ok'){
    badgeTxt.textContent = 'Listo';
  } else if(state === 'warn'){
    badgeTxt.textContent = 'Incompleto';
  } else {
    badgeTxt.textContent = 'Pendiente';
  }
}

function buildSummary(){
  var body=document.getElementById('sum-body'); if(!body) return;
  function row(k,v,chip){
    var empty=!v||!v.trim();
    var vHtml=empty?'<span class="sum-v empty">‚Äî</span>':
      chip?'<span class="sum-chip '+chip+'">'+esc(v)+'</span>':
      '<span class="sum-v">'+esc(v)+'</span>';
    return '<div class="sum-row"><span class="sum-k">'+k+':</span>'+vHtml+'</div>';
  }
  function grp(ico,ttl,rows){
    return '<div class="sum-grp"><div class="sum-grp-lbl"><span class="sum-grp-lbl-ico">'+ico+'</span>'+
      '<span class="sum-grp-lbl-txt">'+ttl+'</span></div>'+rows+'</div>';
  }
  var nom=[gv('f-nombre'),gv('f-snombre'),gv('f-ap'),gv('f-am')].filter(Boolean).join(' ');
  var telFull=(gv('val-lada')+' '+gv('f-tel')).trim();
  var cpVis = document.getElementById('cp-extra').classList.contains('visible');
  var mV=gv('val-marca'), mFinal=mV==='Otra marca'?'Otra ('+(gv('f-marca-otro')||'‚Äî')+')':mV;
  var archStr=S.files.length?(S.files.length+' archivo(s)'+(S.zipBlob?' ‚Äî ZIP: '+fmt(S.zipBlob.size):'')):'';

  body.innerHTML=
    grp('üë§','Datos Personales',
      row('Nombre completo',nom)+row('G√©nero',gv('val-genero'))+row('Nacimiento',gv('f-nacimiento'))+
      row('CURP',gv('f-curp'))+row('RFC',gv('f-rfc'))+row('Tel√©fono',telFull)+row('Correo',gv('f-email'))
    )+
    grp('üìç','Domicilio',
      row('C√≥digo Postal',gv('f-cp'))+
      (cpVis ? row('Estado',gv('cp-estado'))+row('Municipio',gv('cp-municipio'))+row('Colonia',gv('val-colonia')) : '')
    )+
    grp('üöó','Veh√≠culo',
      row('Tipo',gv('val-tipo'),'sum-chip')+row('Marca',mFinal,'sum-chip')+row('Versi√≥n',gv('f-version'))+
      row('A√±o',gv('val-anio'))+row('VIN',gv('f-vin'))+row('Motor',gv('f-motor'))+row('Clave',gv('f-clave'))
    )+
    grp('üìé','Documentos',row('Archivos',archStr,archStr?'files':''));

  /* Actualizar badge con la nueva l√≥gica de 3 estados */
  updateBadge();
}

function isComplete(){
  var ok=true;
  document.querySelectorAll('[data-req]').forEach(function(el){
    if(el.type==='hidden'){ var v=el.value.trim(); if(!v) ok=false; return; }
    if(!el.offsetParent&&el.type!=='hidden') return;
    if(!el.value.trim()) ok=false;
  });
  var cpVis = document.getElementById('cp-extra').classList.contains('visible');
  if(cpVis && !gv('val-colonia')) ok=false;
  if(!CURP_RE.test(gv('f-curp'))) ok=false;
  if(!RFC_PF.test(gv('f-rfc'))&&!RFC_PM.test(gv('f-rfc'))) ok=false;
  if(!S.files.length) ok=false;
  if(gv('val-marca')==='Otra marca'&&!gv('f-marca-otro')) ok=false;
  return ok;
}

function onChange2(){
  buildSummary();
  var declOk=document.getElementById('decl').classList.contains('checked');
  document.getElementById('btn-send').disabled=!declOk;
  document.getElementById('decl-req').style.display=declOk?'none':'block';
  updateProgress();
}

/* ‚ïê‚ïê DECLARACI√ìN ‚ïê‚ïê */
function toggleDecl(){ document.getElementById('decl').classList.toggle('checked'); onChange2(); }

/* ‚ïê‚ïê BARRA DE PROGRESO ‚ïê‚ïê */
function updateProgress(){
  var fields=[];
  document.querySelectorAll('[data-req]').forEach(function(el){
    if(el.type==='hidden'){
      var cap=el; fields.push(function(){return !!cap.value.trim();});
    } else if(el.offsetParent){
      var cap=el; fields.push(function(){return !!cap.value.trim();});
    }
  });
  var cpVis = document.getElementById('cp-extra').classList.contains('visible');
  if(cpVis){
    fields.push(function(){return !!gv('val-colonia');});
  }
  fields.push(function(){return S.files.length>0;});
  fields.push(function(){return document.getElementById('decl').classList.contains('checked');});
  var tot=fields.length, don=fields.filter(function(f){return f();}).length;
  document.getElementById('prog-fill').style.width=(tot?don/tot*100:0)+'%';
  document.getElementById('prog-done').textContent=don;
  document.getElementById('prog-total').textContent=tot;
}

/* ‚ïê‚ïê SCROLL AL PRIMER CAMPO INV√ÅLIDO ‚ïê‚ïê */
function scrollToFirst(){
  var checks=[
    {t:'i',id:'f-nombre'},{t:'i',id:'f-ap'},{t:'i',id:'f-am'},
    {t:'s',id:'val-genero',b:'btn-genero'},{t:'i',id:'f-nacimiento'},
    {t:'i',id:'f-curp',v:'curp'},{t:'i',id:'f-rfc',v:'rfc'},
    {t:'i',id:'f-cp'},{t:'col'},
    {t:'i',id:'f-tel'},{t:'i',id:'f-email'},
    {t:'s',id:'val-tipo',b:'btn-tipo'},{t:'s',id:'val-marca',b:'btn-marca'},
    {t:'mo'},{t:'i',id:'f-version'},{t:'s',id:'val-anio',b:'btn-anio'},
    {t:'i',id:'f-vin'},{t:'i',id:'f-motor'},{t:'i',id:'f-clave'},
    {t:'files'}
  ];
  function flash(el){ el.classList.add('vi'); setTimeout(function(){el.classList.remove('vi');},2000); }
  function flashBtn(id){ var b=document.getElementById(id); if(b){ b.style.borderColor='var(--err)'; setTimeout(function(){b.style.borderColor='';},2000); b.scrollIntoView({behavior:'smooth',block:'center'}); } }

  for(var i=0;i<checks.length;i++){
    var c=checks[i];
    if(c.t==='i'){
      var el=document.getElementById(c.id); if(!el||(!el.offsetParent&&el.id!=='f-cp')) continue;
      var bad=!el.value.trim();
      if(!bad&&c.v==='curp') bad=!CURP_RE.test(el.value);
      if(!bad&&c.v==='rfc') bad=!RFC_PF.test(el.value)&&!RFC_PM.test(el.value);
      if(bad){ el.scrollIntoView({behavior:'smooth',block:'center'}); el.focus(); flash(el); return true; }
    } else if(c.t==='s'){
      var h=document.getElementById(c.id); if(!h) continue;
      if(!h.value.trim()){ flashBtn(c.b); return true; }
    } else if(c.t==='col'){
      var cpVis = document.getElementById('cp-extra').classList.contains('visible');
      if(!cpVis) continue;
      if(!gv('val-colonia')){ flashBtn('btn-colonia'); return true; }
    } else if(c.t==='mo'){
      if(gv('val-marca')==='Otra marca'){ var m=document.getElementById('f-marca-otro'); if(m&&!m.value.trim()){ m.scrollIntoView({behavior:'smooth',block:'center'}); m.focus(); flash(m); return true; } }
    } else if(c.t==='files'){
      if(!S.files.length){
        var dz=document.getElementById('dropzone');
        dz.scrollIntoView({behavior:'smooth',block:'center'});
        dz.style.borderColor='var(--err)'; setTimeout(function(){dz.style.borderColor='';},2000);
        return true;
      }
    }
  }
  return false;
}

function initSubmit(){
  document.getElementById('ava-form').addEventListener('submit', function(e){
    e.preventDefault();
    if(scrollToFirst()) return;
    var declOk = document.getElementById('decl').classList.contains('checked');
    if(!declOk){
      document.getElementById('decl-req').style.display = 'block';
      document.getElementById('decl').scrollIntoView({behavior:'smooth', block:'center'});
      return;
    }
    doSend();
  });
}

function doSend(){
  var btn = document.getElementById('btn-send');
  var status = document.getElementById('send-status');
  var statusTxt = document.getElementById('send-status-txt');
  btn.disabled = true;
  status.className = 'send-status loading';
  statusTxt.textContent = 'Preparando env√≠o...';

  if(S.compressing){
    statusTxt.textContent = 'Esperando compresi√≥n del ZIP...';
    var poll = setInterval(function(){
      if(!S.compressing){ clearInterval(poll); proceedSend(); }
    }, 300);
    return;
  }
  if(S.files.length && !S.zipBlob){
    statusTxt.textContent = 'Comprimiendo archivos...';
    scheduleCompress();
    var poll2 = setInterval(function(){
      if(S.zipBlob || !S.compressing){ clearInterval(poll2); proceedSend(); }
    }, 300);
    return;
  }
  proceedSend();
}

function proceedSend(){
  var statusTxt = document.getElementById('send-status-txt');
  statusTxt.textContent = 'Verificando seguridad (reCAPTCHA)...';

  if(typeof grecaptcha !== 'undefined'){
    grecaptcha.ready(function(){
      grecaptcha.execute(CFG.RECAPTCHA_SITE_KEY, {action:'submit'})
        .then(function(token){ sendWithFetch(token); })
        .catch(function(){ sendWithFetch(''); });
    });
  } else {
    sendWithFetch('');
  }
}

function sendWithFetch(recaptchaToken){
  var statusTxt = document.getElementById('send-status-txt');
  statusTxt.textContent = 'Enviando solicitud con documentos...';

  var nom = [gv('f-nombre'),gv('f-snombre'),gv('f-ap'),gv('f-am')].filter(Boolean).join(' ');
  var cpVis = document.getElementById('cp-extra').classList.contains('visible');
  var mV = gv('val-marca');
  var mFinal = mV === 'Otra marca' ? 'Otra (' + gv('f-marca-otro') + ')' : mV;

  var fd = new FormData();
  fd.append('_subject',  'Nueva Solicitud AVA ‚Äî ' + nom + ' ‚Äî ' + new Date().toLocaleDateString('es-MX'));
  fd.append('_template', 'table');
  fd.append('_captcha',  'false');
  if(recaptchaToken) fd.append('g-recaptcha-response', recaptchaToken);

  fd.append('Nombre_Completo',  nom);
  fd.append('Genero',           gv('val-genero'));
  fd.append('Fecha_Nacimiento', gv('f-nacimiento'));
  fd.append('CURP',             gv('f-curp'));
  fd.append('RFC',              gv('f-rfc'));
  fd.append('Telefono',         gv('val-lada') + ' ' + gv('f-tel'));
  fd.append('Email',            gv('f-email'));
  fd.append('Codigo_Postal',    gv('f-cp'));
  if(cpVis){
    fd.append('Estado',    gv('cp-estado'));
    fd.append('Municipio', gv('cp-municipio'));
    fd.append('Colonia',   gv('val-colonia'));
  }
  fd.append('Tipo_Vehiculo',   gv('val-tipo'));
  fd.append('Marca',           mFinal);
  fd.append('Version',         gv('f-version'));
  fd.append('Anio_Modelo',     gv('val-anio'));
  fd.append('Num_Serie_VIN',   gv('f-vin'));
  fd.append('Num_Motor',       gv('f-motor'));
  fd.append('Clave_Vehicular', gv('f-clave'));

  if(S.zipBlob){
    var zipFile = new File([S.zipBlob], 'documentos-' + today() + '.zip', {type:'application/zip'});
    fd.append('attachment', zipFile, zipFile.name);
  }

  fetch(CFG.FORMSUBMIT_URL, {method:'POST', body:fd})
    .then(function(){ showModal(); resetSendUI(); })
    .catch(function(){ showModal(); resetSendUI(); });
}

function resetSendUI(){
  var status = document.getElementById('send-status');
  status.className = 'send-status';
  document.getElementById('btn-send').disabled = false;
}

/* ‚ïê‚ïê MODAL ‚ïê‚ïê */
function showModal(){
  document.getElementById('modalBg').classList.add('on');
  document.body.style.overflow='hidden';
}
function closeModal(){
  document.getElementById('modalBg').classList.remove('on');
  document.body.style.overflow='';
  resetForm();
  window.scrollTo({top:0,behavior:'smooth'});
}
document.getElementById('modalBg').addEventListener('click',function(e){
  if(e.target===this) closeModal();
});

/* ‚ïê‚ïê RESET ‚ïê‚ïê */
function resetForm(){
  document.getElementById('ava-form').reset();
  S={files:[],zipBlob:null,compressing:false,_runId:0,startTime:null};
  document.getElementById('file-list').innerHTML='';
  document.getElementById('rt-stats').style.display='none';
  document.getElementById('compress-box').classList.remove('on');
  document.getElementById('cap-wrap').classList.remove('on');

  var extra = document.getElementById('cp-extra');
  extra.classList.remove('visible');
  document.getElementById('cp-ok-badge').style.display = 'none';
  document.getElementById('cp-estado').value    = '';
  document.getElementById('cp-municipio').value = '';
  document.getElementById('rf-estado-val').textContent   = '‚Äî';
  document.getElementById('rf-municipio-val').textContent = '‚Äî';
  document.getElementById('rf-estado').classList.remove('filled');
  document.getElementById('rf-municipio').classList.remove('filled');
  document.getElementById('col-count-helper').textContent = '';

  document.getElementById('marca-otro-wrap').style.display='none';
  document.getElementById('f-marca-otro').value='';
  document.getElementById('decl').classList.remove('checked');

  function resetBtn(id,ph){
    var el=document.getElementById(id);
    if(el) el.innerHTML='<span class="csel-ph">'+ph+'</span><svg class="csel-arrow" width="12" height="8" viewBox="0 0 12 8" fill="none"><path d="M1 1l5 5 5-5" stroke-width="2" stroke-linecap="round"/></svg>';
  }
  resetBtn('btn-genero','Selecciona...');
  resetBtn('btn-tipo','Selecciona...');
  resetBtn('btn-anio','Selecciona a√±o...');
  resetBtn('btn-colonia','Selecciona tu colonia...');
  resetBtn('btn-marca','Selecciona una marca...');
  document.querySelectorAll('input[type=hidden]').forEach(function(el){ if(el.id==='val-lada') el.value='+52'; else el.value=''; });
  document.getElementById('lada-flag').textContent='üá≤üáΩ';
  document.getElementById('lada-code').textContent='+52';
  document.querySelectorAll('.vi,.vok').forEach(function(el){ el.classList.remove('vi','vok'); });
  document.querySelectorAll('.ferr.on').forEach(function(el){ el.classList.remove('on'); });
  onChange2();
}

/* ‚ïê‚ïê UTILIDADES ‚ïê‚ïê */
function fmt(b){ if(b<1024)return b+' B'; if(b<1048576)return (b/1024).toFixed(1)+' KB'; return (b/1048576).toFixed(2)+' MB'; }
function fmtS(s){ return s<60?Math.round(s)+'s':Math.floor(s/60)+'m '+Math.round(s%60)+'s'; }
function fileIco(n){ var e=n.split('.').pop().toLowerCase(); return ['jpg','jpeg','png','gif','webp'].indexOf(e)>=0?'üñºÔ∏è':e==='pdf'?'üìÑ':'üìé'; }
function today(){ var d=new Date(); return d.getFullYear()+'-'+(d.getMonth()+1).toString().padStart(2,'0')+'-'+d.getDate().toString().padStart(2,'0'); }
</script>
</body>
</html>
