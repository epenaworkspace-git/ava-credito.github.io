 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/index.html b/index.html
index 9c7c9b2138145d24a6cc1230093d995d9db523c1..6fdfa074903951037a717fd5ab6973a2a6d9e070 100644
--- a/index.html
+++ b/index.html
@@ -538,107 +538,127 @@ document.querySelectorAll('.step').forEach(function(s){
 // â”€â”€ YEAR SELECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 (function(){
   var s=Q('anio'),y=new Date().getFullYear();
   for(var i=y;i>=2000;i--){ var o=document.createElement('option'); o.value=i; o.textContent=i; s.appendChild(o); }
 })();
 
 // â”€â”€ RFC/CURP UPPERCASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 ['rfc','curp'].forEach(function(id){
   Q(id).addEventListener('input',function(){ this.value=this.value.toUpperCase(); });
 });
 
 // â”€â”€ EDAD AUTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 Q('fNac').addEventListener('change',function(){
   if(!this.value){ Q('edad').value=''; return; }
   var b=new Date(this.value),t=new Date(),a=t.getFullYear()-b.getFullYear();
   if(t.getMonth()<b.getMonth()||(t.getMonth()===b.getMonth()&&t.getDate()<b.getDate())) a--;
   Q('edad').value=a>=0?a+' aÃ±os':'';
 });
 
 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 //  CURP â€” ValidaciÃ³n COPOMEX
 //  Endpoint: GET /query/validar_curp/{CURP}?token=...
 //  Respuesta: { message:{...}, error:false }
 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 var CURP_TOKEN='22a42fe7-6d79-42c2-84e8-99ffaf77653d';
+var CURP_API_BASE='https://api.copomex.com/query/validar_curp/';
+var CURP_PROXY='https://api.allorigins.win/raw?url=';
 var curpTimer=null;
 var curpValid=false;
 
 function curpSetStatus(type, msg, showSpin){
   var st=Q('curpStatus');
   st.className='curp-status';
   if(type){ st.classList.add(type); }
   Q('curpSpinEl').style.display=showSpin?'inline-block':'none';
   Q('curpMsg').textContent=msg;
 }
 
 function curpClear(){
   curpValid=false;
   Q('curpStatus').className='curp-status'; // oculto
   Q('curpSpinEl').style.display='none';
   Q('curpMsg').textContent='';
   var inp=Q('curp'); inp.classList.remove('ok','bad');
   var e=Q('ecurp'); if(e) e.textContent='';
 }
 
+function curpBuildUrl(val){
+  return CURP_API_BASE+encodeURIComponent(val)+'?token='+encodeURIComponent(CURP_TOKEN);
+}
+
+function curpFetch(url, useProxy){
+  var target=useProxy?(CURP_PROXY+encodeURIComponent(url)):url;
+  return fetch(target).then(function(r){
+    if(!r.ok) throw new Error('HTTP '+r.status);
+    return r.json();
+  });
+}
+
+function curpNormalizeResponse(data){
+  if(Array.isArray(data)) return data[0]||{};
+  return data||{};
+}
+
+function curpIsInvalid(data){
+  return data.error===true||data.error==='true'||(data.message&&data.message.error) || (typeof data.message==='string'&&/no existe|no encontrada|invalida/i.test(data.message));
+}
+
 function curpValidate(val){
   if(val.length!==18){ curpClear(); return; }
-  // Formato bÃ¡sico primero
   if(!/^[A-Z]{4}\d{6}[HM][A-Z]{5}[A-Z0-9]{2}$/.test(val)){
     curpSetStatus('err-s','Formato de CURP invÃ¡lido',false);
     Q('curp').classList.add('bad'); Q('curp').classList.remove('ok');
     return;
   }
   curpSetStatus('load-s','Verificando CURP...', true);
-  fetch('https://api.copomex.com/query/validar_curp/'+val+'?token='+CURP_TOKEN)
-    .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
-    .then(function(data){
-      // COPOMEX responde { error:false, message:{...datos...} }
-      // Si error:true o message.error, la CURP no existe
-      if(data.error===true||data.error==='true'||(data.message&&data.message.error)){
+  var url=curpBuildUrl(val);
+  curpFetch(url,false)
+    .catch(function(){ return curpFetch(url,true); })
+    .then(function(raw){
+      var data=curpNormalizeResponse(raw);
+      if(curpIsInvalid(data)){
         curpValid=false;
-        curpSetStatus('err-s','âš  CURP no encontrada en el RENAPO',false);
+        curpSetStatus('err-s','âš  CURP no encontrada en RENAPO',false);
         Q('curp').classList.add('bad'); Q('curp').classList.remove('ok');
         return;
       }
-      var m=data.message||{};
-      // Nombre de la persona (opcional, para mostrar)
+      var m=data.message||data.response||{};
       var nombre='';
-      if(m.nombre||m.nombres||m.primerApellido){
+      if(m&&typeof m==='object'&&(m.nombre||m.nombres||m.primerApellido)){
         nombre=' â€” '+(m.nombres||m.nombre||'')+' '+(m.primerApellido||'')+' '+(m.segundoApellido||'');
         nombre=nombre.replace(/\s+/g,' ').trim();
         if(nombre==='-') nombre='';
       }
       curpValid=true;
       curpSetStatus('ok-s','âœ“ CURP vÃ¡lida'+nombre,false);
       Q('curp').classList.add('ok'); Q('curp').classList.remove('bad');
       var e=Q('ecurp'); if(e) e.textContent='';
     })
-    .catch(function(err){
-      // Si hay error de red, no bloqueamos â€” solo avisamos
+    .catch(function(){
       curpValid=false;
-      curpSetStatus('err-s','Sin conexiÃ³n al verificar CURP (revisa tu internet)',false);
+      curpSetStatus('err-s','No se pudo validar con COPOMEX por ahora. Puedes continuar.',false);
       Q('curp').classList.remove('ok');
     });
 }
 
 Q('curp').addEventListener('input',function(){
   this.value=this.value.toUpperCase();
   curpClear();
   clearTimeout(curpTimer);
   var v=this.value;
   if(v.length===18){
     curpTimer=setTimeout(function(){ curpValidate(v); },600);
   }
 });
 Q('curp').addEventListener('blur',function(){
   clearTimeout(curpTimer);
   var v=this.value;
   if(v.length===18) curpValidate(v);
 });
 
 // â”€â”€ ESTADO CIVIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 Q('estCivil').addEventListener('change',function(){
   var blk=Q('regimenBlk'), sel=Q('regimen');
   if(this.value==='Casado(a)'){
     blk.classList.add('open'); sel.disabled=false;
   } else {
@@ -678,51 +698,51 @@ function buildDepFields(n){
 Q('tieneDep').addEventListener('change',function(){
   var blk=Q('depBlk'), num=Q('numDep'); clrErr('tieneDep');
   if(this.value==='Si'){ blk.classList.add('open'); num.disabled=false; }
   else{
     blk.classList.remove('open'); num.disabled=true; num.value='';
     Q('depAges').innerHTML=''; num.classList.remove('ok','bad');
     Q('edepAges').textContent=''; var e=Q('enumDep'); if(e) e.textContent='';
   }
 });
 Q('numDep').addEventListener('change',function(){
   var n=parseInt(this.value); if(n>0) buildDepFields(n); clrErr('numDep');
 });
 
 // â”€â”€ PAYMENT RADIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 document.querySelectorAll('input[name=tipoPago]').forEach(function(r){
   r.addEventListener('change',function(){
     HIDE('payH');
     if(this.value==='enganche'){ SHOWF('engF'); HIDE('monF'); Q('valMon').value=''; }
     else{ SHOWF('monF'); HIDE('engF'); Q('valEng').value=''; }
   });
 });
 
 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 //  COPOMEX â€” CÃ³digo Postal
 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-var CP_TOKEN='36da398a-1848-44f3-a952-06c9bfb02cc8';
+var CP_TOKEN='22a42fe7-6d79-42c2-84e8-99ffaf77653d';
 
 function cpClear(){
   HIDE('cpSpin'); Q('cp').disabled=false;
   HIDE('cpErrBox'); Q('cpErrBox').textContent=''; HIDE('cpRetry');
   HIDE('cpBadges');
   Q('cpMun').textContent=''; Q('cpEst').textContent=''; Q('cpCiu').textContent=''; HIDE('cpCiuWrap');
   HIDE('colBlk');
   Q('colonia').innerHTML='<option value="" disabled selected>Selecciona tu colonia</option>';
   Q('colonia').classList.remove('ok','bad'); Q('colCnt').textContent='';
   HIDE('colRegLbl'); HIDE('colSel'); Q('colSel').value='';
   Q('hMun').value=''; Q('hEst').value=''; Q('hCiu').value='';
   clrErr('cp');
 }
 function cpFail(msg){
   HIDE('cpSpin'); Q('cp').disabled=false;
   Q('cpErrBox').textContent=msg; SHOW('cpErrBox'); SHOW('cpRetry'); setErr('cp',msg);
 }
 function cpFetch(cp){
   cpClear(); SHOW('cpSpin'); Q('cp').disabled=true; clrErr('cp');
   fetch('https://api.copomex.com/query/info_cp/'+cp+'?token='+CP_TOKEN)
     .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
     .then(function(data){
       HIDE('cpSpin'); Q('cp').disabled=false;
       if(!Array.isArray(data)||data.length===0){ cpFail('CÃ³digo postal no encontrado.'); return; }
       var first=data[0];
@@ -914,76 +934,119 @@ function buildSummary(){
 // â”€â”€ UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 var upFiles=[];
 var upA=Q('upA'),upI=Q('upI'),fL=Q('fList');
 upA.addEventListener('dragover',function(e){e.preventDefault();upA.classList.add('drag');});
 upA.addEventListener('dragleave',function(){upA.classList.remove('drag');});
 upA.addEventListener('drop',function(e){e.preventDefault();upA.classList.remove('drag');doFiles(e.dataTransfer.files);});
 upI.addEventListener('change',function(){doFiles(upI.files);upI.value='';});
 function doFiles(fl){
   var errs=[];
   Array.from(fl).forEach(function(f){
     if(upFiles.some(function(x){return x.name===f.name;})) return;
     var ext='.'+f.name.split('.').pop().toLowerCase();
     if(!['.pdf','.jpg','.jpeg','.png','.docx'].includes(ext)){errs.push('"'+f.name+'" no permitido.');return;}
     if(f.size>5242880){errs.push('"'+f.name+'" supera 5MB.');return;}
     upFiles.push(f);
     var d=document.createElement('div'); d.className='f-item';
     d.innerHTML='<span>ğŸ“„</span><span class="f-nm">'+f.name+'</span><span class="f-sz">'+fmtSz(f.size)+'</span><span class="f-ok">âœ“</span><button type="button" class="f-rm">âœ•</button>';
     d.querySelector('.f-rm').addEventListener('click',function(){upFiles=upFiles.filter(function(x){return x.name!==f.name;});d.remove();});
     fL.appendChild(d);
   });
   var eu=Q('eupErr');
   if(errs.length){eu.textContent=errs.join(' ');eu.style.display='block';} else eu.style.display='none';
 }
 function fmtSz(b){return b<1048576?(b/1024).toFixed(0)+'KB':(b/1048576).toFixed(1)+'MB';}
 
-// â”€â”€ SUBMIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
+// â”€â”€ SUBMIT (FormSubmit) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
+var FORMSUBMIT_URL='https://formsubmit.co/ajax/info@anpai.com.mx';
+
 Q('frm').addEventListener('submit',function(e){
   e.preventDefault();
+  var form=Q('frm');
+  var submitBtn=Q('btnSub');
+  var errBox=Q('eupErr');
   for(var s=1;s<=3;s++){ if(!validateSection(s)){ slideTo(s); return; } }
+
   var nm=[V('pNombre'),V('sNombre'),V('pApellido'),V('sApellido')].filter(Boolean).join(' ').replace(/\s+/,' ').trim();
   var tp=document.querySelector('input[name=tipoPago]:checked');
   var pago=tp?(tp.value==='enganche'?'Enganche: '+V('valEng'):'Monto Inicial: MX$'+V('valMon')):'';
   var depStr='No';
   if(V('tieneDep')==='Si'){
     var nd=parseInt(V('numDep'))||0;
     var ages2=[];
     for(var i=1;i<=nd;i++){
       var sv2=V('depAge'+i),mv2=V('depAge'+i+'M');
       ages2.push('Dep.'+i+': '+(sv2==='manual'?(mv2+' aÃ±os'):sv2));
     }
     depStr='SÃ­ ('+nd+') â€” '+ages2.join(', ');
   }
+
   var body=[
     'DATOS PERSONALES','â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
     'Nombre: '+nm,'GÃ©nero: '+V('genero'),'Fecha Nac.: '+V('fNac'),'Edad: '+V('edad'),
     'Estado Civil: '+V('estCivil'),
     V('estCivil')==='Casado(a)'?'RÃ©gimen Matrimonial: '+V('regimen'):'',
     'Dependientes: '+depStr,
     'RFC: '+V('rfc'),'CURP: '+V('curp'),
     'C.P.: '+V('cp'),'Colonia: '+(V('colSel')||V('colonia')),
     'Municipio: '+V('hMun'),'Estado: '+V('hEst'),
     '','REFERENCIAS','â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
     'Fam1: '+V('f1n')+' | Tel: '+V('f1t')+' | '+V('f1e'),'Dir: '+V('f1d'),
     'Fam2: '+V('f2n')+' | Tel: '+V('f2t')+' | '+V('f2e'),'Dir: '+V('f2d'),
     'Ami1: '+V('a1n')+' | Tel: '+V('a1t')+' | '+V('a1e'),'Dir: '+V('a1d'),
     'Ami2: '+V('a2n')+' | Tel: '+V('a2t')+' | '+V('a2e'),'Dir: '+V('a2d'),
     '','VEHÃCULO','â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€',
     'Marca: '+V('marca'),'VersiÃ³n: '+V('version'),'AÃ±o: '+V('anio'),
     'Costo: MX$'+V('costo'),'Pago: '+pago,
     'Archivos: '+(upFiles.length?upFiles.map(function(f){return f.name;}).join(', '):'Ninguno')
   ].filter(function(l){return l!==undefined&&l!=='';}).join('\n');
-  window.location.href='mailto:info@anpai.com.mx?subject='+encodeURIComponent('SOLICITUD CRÃ‰DITO VEHICULAR - '+nm)+'&body='+encodeURIComponent(body);
-  setTimeout(function(){ Q('modal').classList.add('on'); },600);
+
+  var fd=new FormData(form);
+  fd.append('_subject','SOLICITUD CRÃ‰DITO VEHICULAR - '+nm);
+  fd.append('_captcha','false');
+  fd.append('_template','table');
+  fd.append('nombreCompleto',nm);
+  fd.append('mensaje',body);
+  upFiles.forEach(function(file){ fd.append('attachment',file,file.name); });
+
+  submitBtn.disabled=true;
+  submitBtn.textContent='Enviando...';
+  errBox.style.display='none';
+  errBox.textContent='';
+
+  fetch(FORMSUBMIT_URL,{ method:'POST', headers:{ 'Accept':'application/json' }, body:fd })
+    .then(function(r){
+      return r.json().catch(function(){ return {}; }).then(function(payload){
+        if(!r.ok||(payload&&payload.success===false)) throw new Error(payload.message||'No se pudo enviar el formulario.');
+        return payload;
+      });
+    })
+    .then(function(){
+      form.reset();
+      upFiles=[];
+      fL.innerHTML='';
+      curpClear();
+      cpClear();
+      slideTo(1);
+      Q('modal').classList.add('on');
+    })
+    .catch(function(err){
+      errBox.textContent=err&&err.message?err.message:'OcurriÃ³ un error al enviar. Intenta de nuevo.';
+      errBox.style.display='block';
+    })
+    .finally(function(){
+      submitBtn.disabled=false;
+      submitBtn.innerHTML='Enviar Solicitud <svg viewBox="0 0 24 24"><path d="M3.4 20.4l17.45-8.1a.9.9 0 000-1.64L3.4 2.6a.9.9 0 00-1.28 1.02l1.62 6.3a.9.9 0 00.69.66l8.18 1.7-8.18 1.7a.9.9 0 00-.69.66l-1.62 6.3A.9.9 0 003.4 20.4z"/></svg>';
+    });
 });
 
 Q('mClose').addEventListener('click',function(){Q('modal').classList.remove('on');});
 Q('modal').addEventListener('click',function(e){if(e.target===this)this.classList.remove('on');});
 document.addEventListener('keydown',function(e){if(e.key==='Escape')Q('modal').classList.remove('on');});
 
 // â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 slideTo(1);
 
 })();
 </script>
 </body>
 </html>
 
EOF
)
